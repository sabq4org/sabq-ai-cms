generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model EmailJob {
  id            String          @id
  template_id   String?
  scheduled_at  DateTime?
  started_at    DateTime?
  completed_at  DateTime?
  status        EmailJob_status @default(queued)
  target_filter Json?
  metadata      Json?
  stats         Json?
  created_at    DateTime        @default(now())
  updated_at    DateTime

  @@index([status, scheduled_at])
}

model EmailLog {
  id              String          @id
  job_id          String?
  subscriber_id   String
  provider_msg_id String?
  message_id      String?
  status          EmailLog_status @default(pending)
  error           String?         @db.Text
  opened_at       DateTime?
  clicked_at      DateTime?
  unsubscribed_at DateTime?
  meta            Json?
  event_at        DateTime        @default(now())

  @@index([status])
  @@index([subscriber_id])
}

model EmailTemplate {
  id           String   @id
  name         String   @db.VarChar(255)
  subject      String   @db.VarChar(500)
  html_content String   @db.Text
  text_content String?  @db.Text
  metadata     Json?
  created_at   DateTime @default(now())
  updated_at   DateTime
}

model users {
  id                 String   @id
  email              String   @unique
  password_hash      String?
  name               String?
  avatar             String?
  role               String
  is_admin           Boolean  @default(false)
  is_verified        Boolean  @default(false)
  verification_token String?
  reset_token        String?
  reset_token_expiry DateTime? @db.Timestamp(6)
  created_at         DateTime  @default(now()) @db.Timestamp(6)
  updated_at         DateTime  @updatedAt @db.Timestamp(6)
  
  // علاقات
  articles           articles[]
  comments           comments[]
  loyalty_points     loyalty_points[]
  activity_logs      activity_logs[]
  interactions       interactions[]
  reading_sessions   reading_sessions[]
}

model categories {
  id            String   @id
  name          String
  slug          String   @unique
  description   String?
  display_order Int
  is_active     Boolean
  color         String?  @db.VarChar(50)
  icon          String?  @db.VarChar(50)
  metadata      Json?
  name_en       String?
  parent_id     String?
  created_at    DateTime @db.Timestamp(6)
  updated_at    DateTime @db.Timestamp(6)
  
  // علاقات
  articles      articles[]
}

model articles {
  id                String    @id
  title             String    @db.VarChar(500)
  slug              String    @db.VarChar(500)
  content           String
  excerpt           String?
  author_id         String
  category_id       String?
  status            String
  featured          Boolean
  breaking          Boolean
  featured_image    String?
  published_at      DateTime? @db.Timestamp(6)
  scheduled_for     DateTime? @db.Timestamp(6)
  views             Int
  reading_time      Int?
  seo_title         String?
  seo_description   String?
  seo_keywords      String?
  social_image      String?
  allow_comments    Boolean
  metadata          Json?
  created_at        DateTime  @db.Timestamp(6)
  updated_at        DateTime  @db.Timestamp(6)
  audio_summary_url String?
  likes             Int
  saves             Int
  shares            Int
  
  // علاقات
  author            users             @relation(fields: [author_id], references: [id])
  category          categories?       @relation(fields: [category_id], references: [id])
  comments          comments[]
  deep_analyses     deep_analyses[]
  interactions      interactions[]
  reading_sessions  reading_sessions[]
  @@map("articles")
}

model comments {
  id         String   @id
  article_id String
  user_id    String?
  parent_id  String?
  content    String
  status     String
  likes      Int
  metadata   Json?
  created_at DateTime @db.Timestamp(6)
  updated_at DateTime @db.Timestamp(6)
  
  // علاقات
  article    articles? @relation(fields: [article_id], references: [id])
  user       users?    @relation(fields: [user_id], references: [id])
  parent     comments? @relation("CommentReplies", fields: [parent_id], references: [id])
  replies    comments[] @relation("CommentReplies")
}

model loyalty_points {
  id             String   @id
  user_id        String
  points         Int
  action         String   @db.VarChar(100)
  reference_id   String?
  reference_type String?
  metadata       Json?
  created_at     DateTime @default(now()) @db.Timestamp(6)
  
  // علاقات
  user           users    @relation(fields: [user_id], references: [id])
}

model deep_analyses {
  id                  String   @id
  article_id          String
  ai_summary          String?
  key_topics          Json?
  tags                Json?
  sentiment           String?
  readability_score   Decimal? @db.Decimal
  engagement_score    Int?
  suggested_headlines Json?
  related_articles    Json?
  metadata            Json?
  analyzed_at         DateTime @db.Timestamp(6)
  updated_at          DateTime @db.Timestamp(6)
  
  // علاقات
  article             articles @relation(fields: [article_id], references: [id])
}

model activity_logs {
  id          String   @id
  user_id     String?
  action      String
  entity_type String?
  entity_id   String?
  old_value   Json?
  new_value   Json?
  metadata    Json?
  ip_address  String?  @db.VarChar(45)
  user_agent  String?
  created_at  DateTime @db.Timestamp(6)
  
  // علاقات
  user        users?   @relation(fields: [user_id], references: [id])
}

model roles {
  id           String   @id
  name         String   @unique @db.VarChar(100)
  slug         String?
  display_name String?
  description  String?
  permissions  Json?
  is_system    Boolean
  created_at   DateTime @db.Timestamp(6)
  updated_at   DateTime @db.Timestamp(6)
}

model user_preferences {
  id         String   @id
  user_id    String
  key        String
  value      Json
  created_at DateTime @db.Timestamp(6)
  updated_at DateTime @db.Timestamp(6)

  @@unique([user_id, key])
  @@index([user_id])
}

model user_roles {
  id         String    @id
  user_id    String
  role_id    String
  granted_by String?
  granted_at DateTime  @db.Timestamp(6)
  expires_at DateTime? @db.Timestamp(6)
}

model keywords {
  id         String   @id
  name       String
  slug       String
  count      Int
  created_at DateTime @db.Timestamp(6)
}

model messages {
  id            String    @id
  from_user_id  String?
  to_user_id    String?
  email         String
  subject       String?   @db.VarChar(500)
  message       String
  status        String
  replied_at    DateTime? @db.Timestamp(6)
  reply_content String?
  metadata      Json?
  created_at    DateTime  @db.Timestamp(6)
}

model timeline_events {
  id             String   @id
  event_type     String   @db.VarChar(50)
  entity_type    String   @db.VarChar(50)
  entity_id      String?
  title          String   @db.VarChar(500)
  description    String?
  icon           String?  @db.VarChar(50)
  url            String?  @db.VarChar(500)
  user_id        String?
  author_name    String?  @db.VarChar(255)
  author_avatar  String?
  category_name  String?  @db.VarChar(255)
  category_color String?  @db.VarChar(50)
  metadata       Json?
  is_important   Boolean
  created_at     DateTime @db.Timestamp(6)
}

model team_members {
  id            String   @id
  name          String   @db.VarChar(255)
  role          String   @db.VarChar(100)
  department    String?  @db.VarChar(100)
  bio           String?
  avatar        String?
  email         String?  @db.VarChar(255)
  phone         String?  @db.VarChar(50)
  social_links  Json?
  is_active     Boolean
  display_order Int
  created_at    DateTime @db.Timestamp(6)
  updated_at    DateTime @db.Timestamp(6)
}

model smart_blocks {
  id            String    @id
  name          String    @db.VarChar(255)
  type          String    @db.VarChar(50)
  config        Json
  ai_config     Json?
  display_rules Json?
  is_active     Boolean
  last_updated  DateTime? @db.Timestamp(6)
  performance   Json?
  created_at    DateTime  @db.Timestamp(6)
  updated_at    DateTime  @db.Timestamp(6)
}

model home_blocks_config {
  id            String   @id
  block_type    String   @db.VarChar(50)
  title         String   @db.VarChar(255)
  subtitle      String?  @db.VarChar(255)
  settings      Json
  display_order Int
  is_active     Boolean
  created_at    DateTime @db.Timestamp(6)
  updated_at    DateTime @db.Timestamp(6)
}

model site_settings {
  id         String   @id
  section    String   @db.VarChar(50)
  data       Json
  created_at DateTime @db.Timestamp(6)
  updated_at DateTime @db.Timestamp(6)
}

model templates {
  id           String   @id
  name         String   @db.VarChar(255)
  slug         String   @db.VarChar(255)
  description  String?
  category     String   @db.VarChar(50)
  content      Json
  variables    Json?
  preview_data Json?
  is_active    Boolean
  usage_count  Int
  created_by   String?
  created_at   DateTime @db.Timestamp(6)
  updated_at   DateTime @db.Timestamp(6)
}

model was_news {
  id               String   @id @default(uuid())
  news_NUM         Int
  news_DT          DateTime @db.Timestamp(6)
  news_basket_CD   Int
  news_class_CD    Int
  news_priority_CD Int
  is_Report        Boolean
  title_TXT        String
  story_TXT        String?
  media            Json?
  royalType        Int?
  keywords         Json?
  related_news_CD  Int?
  is_imported      Boolean
  imported_to_id   String?
  created_at       DateTime @db.Timestamp(6)
  updated_at       DateTime @db.Timestamp(6)
}

model user_reading_sessions {
  id               String    @id @db.VarChar(36)
  user_id          String    @db.VarChar(36)
  article_id       String    @db.VarChar(36)
  started_at       DateTime? @db.Timestamptz(6)
  ended_at         DateTime? @db.Timestamptz(6)
  duration_seconds Int?
  read_percentage  Float?
  scroll_depth     Float?
  device_type      String?   @db.VarChar(50)
  time_of_day      Int?
  created_at       DateTime? @db.Timestamptz(6)
}

model user_insights {
  id                      String    @id @db.VarChar(36)
  user_id                 String    @unique @db.VarChar(36)
  total_reads             Int?
  total_saved             Int?
  total_interactions      Int?
  avg_read_time           Float?
  preferred_reading_time  String?   @db.VarChar(50)
  reader_type             String?   @db.VarChar(50)
  diversity_score         Float?
  preferred_categories    Json?
  preferred_article_types Json?
  avg_article_length      Int?
  weekly_reads            Int?
  weekly_streak           Int?
  last_read_date          DateTime? @db.Timestamptz(6)
  calculated_at           DateTime? @db.Timestamptz(6)
  updated_at              DateTime? @updatedAt @db.Timestamptz(6)
}

model user_similar_readers {
  id                String    @id @db.VarChar(36)
  user_id           String    @db.VarChar(36)
  similar_user_id   String    @db.VarChar(36)
  similarity_score  Float?
  common_categories Json?
  calculated_at     DateTime? @db.Timestamptz(6)
}

// جدول رموز التحقق من البريد الإلكتروني
model email_verification_codes {
  id         String   @id
  email      String   @db.VarChar(255)
  code       String   @db.VarChar(6)
  user_id    String?
  expires_at DateTime
  used_at    DateTime?
  created_at DateTime @default(now())

  @@index([email])
  @@index([code])
  @@index([expires_at])
}

model interactions {
  id         String            @id @db.VarChar(36)
  user_id    String            @db.VarChar(36)
  article_id String            @db.VarChar(36)
  type       interactions_type
  created_at DateTime          @default(now()) @db.Timestamptz(6)
  
  // بيانات تفصيلية للتفاعل
  duration       Int?          // مدة البقاء بالثواني
  scroll_depth   Float?        // نسبة التمرير (0.0 - 1.0)
  reading_progress Float?      // نسبة القراءة المكتملة (0.0 - 1.0)
  device_type    String?       @db.VarChar(50) // mobile, desktop, tablet
  source         String?       @db.VarChar(100) // home, search, direct, social
  session_id     String?       @db.VarChar(100) // معرف الجلسة
  ip_address     String?       @db.VarChar(45) // عنوان IP
  user_agent     String?       @db.Text // معلومات المتصفح
  referrer       String?       @db.Text // الموقع المُحيل
  metadata       Json?         // بيانات إضافية

  // Relations
  article    articles          @relation(fields: [article_id], references: [id])
  user       users             @relation(fields: [user_id], references: [id])

  @@unique([user_id, article_id, type])
  @@index([article_id])
  @@index([user_id])
  @@index([created_at])
  @@index([device_type])
  @@index([source])
}

enum interactions_type {
  like
  save
  share
  comment
  view
  reading_session  // جلسة قراءة مفصلة
}

// نموذج جلسات القراءة التفصيلية
model reading_sessions {
  id               String   @id @db.VarChar(36)
  user_id          String   @db.VarChar(36)
  article_id       String   @db.VarChar(36)
  session_id       String   @db.VarChar(100)
  
  // تفاصيل الجلسة
  start_time       DateTime @default(now()) @db.Timestamptz(6)
  end_time         DateTime? @db.Timestamptz(6)
  total_duration   Int?     // إجمالي الوقت بالثواني
  active_duration  Int?     // الوقت النشط (بدون خمول)
  idle_time        Int?     // وقت الخمول
  
  // تفاصيل القراءة
  scroll_depth     Float?   // أقصى نسبة تمرير
  reading_progress Float?   // نسبة القراءة المكتملة
  words_read       Int?     // عدد الكلمات المقروءة تقريباً
  reading_speed    Int?     // سرعة القراءة (كلمة/دقيقة)
  
  // معلومات الجهاز والمتصفح
  device_type      String?  @db.VarChar(50)
  screen_size      String?  @db.VarChar(20) // 1920x1080
  browser          String?  @db.VarChar(50)
  operating_system String?  @db.VarChar(50)
  
  // معلومات الموقع والمصدر
  ip_address       String?  @db.VarChar(45)
  country          String?  @db.VarChar(50)
  city             String?  @db.VarChar(100)
  referrer         String?  @db.Text
  source           String?  @db.VarChar(100)
  
  // سلوكيات التفاعل
  clicks_count     Int?     @default(0) // عدد النقرات
  scrolls_count    Int?     @default(0) // عدد مرات التمرير
  copy_events      Int?     @default(0) // نسخ النص
  share_events     Int?     @default(0) // مشاركات
  
  // بيانات إضافية
  engagement_score Float?   // نقاط التفاعل المحسوبة
  completed        Boolean? @default(false) // هل أكمل القراءة
  metadata         Json?    // بيانات إضافية
  
  // Relations
  article          articles @relation(fields: [article_id], references: [id])
  user             users    @relation(fields: [user_id], references: [id])
  
  @@index([user_id])
  @@index([article_id])
  @@index([session_id])
  @@index([start_time])
  @@index([device_type])
  @@index([completed])
}

model Subscriber {
  id          String            @id
  email       String            @unique
  name        String?           @db.VarChar(255)
  status      Subscriber_status @default(active)
  preferences Json?
  metadata    Json?
  created_at  DateTime          @default(now())
  updated_at  DateTime
}

model daily_doses {
  id          String             @id
  period      daily_doses_period
  title       String             @db.VarChar(500)
  subtitle    String             @db.VarChar(500)
  date        DateTime           @db.Date
  status      daily_doses_status @default(draft)
  publishedAt DateTime?
  views       Int                @default(0)
  metadata    Json?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime

  @@unique([date, period])
  @@index([date])
  @@index([period])
  @@index([status])
}

model dose_contents {
  id           String                    @id
  doseId       String
  articleId    String?
  contentType  dose_contents_contentType
  title        String                    @db.VarChar(500)
  summary      String                    @db.Text
  audioUrl     String?                   @db.Text
  imageUrl     String?                   @db.Text
  displayOrder Int                       @default(0)
  metadata     Json?
  createdAt    DateTime                  @default(now())

  @@index([articleId])
  @@index([doseId])
}

enum daily_doses_period {
  morning
  afternoon
  evening
  night
}

enum daily_doses_status {
  draft
  published
  scheduled
  archived
}

enum dose_contents_contentType {
  article
  weather
  quote
  tip
  audio
  analysis
}

enum Subscriber_status {
  active
  inactive
  unsubscribed
}

enum EmailJob_status {
  queued
  sending
  completed
  cancelled
  failed
}

enum EmailLog_status {
  pending
  sent
  delivered
  bounced
  opened
  clicked
  unsubscribed
  failed
}

// =====================================
// نظام الروابط الذكية - Smart Links
// =====================================

// جدول أنواع الكيانات
model EntityTypes {
  id           String   @id @default(cuid())
  name         String   @unique // person, organization, project, term, location, event
  name_ar      String   // شخص، مؤسسة، مشروع، مصطلح، موقع، حدث
  description  String?
  icon         String?  // emoji أو icon name
  color        String?  // لون مميز للنوع
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  
  // Relations
  entities     SmartEntities[]
  
  @@map("entity_types")
}

// جدول الكيانات الذكية الرئيسي
model SmartEntities {
  id               String   @id @default(cuid())
  name             String   // الاسم الأساسي
  name_ar          String?  // الاسم بالعربية
  name_en          String?  // الاسم بالإنجليزية
  aliases          Json?    // أسماء بديلة ["ولي العهد", "محمد بن سلمان", "الأمير محمد"]
  
  // نوع الكيان
  entity_type_id   String
  entity_type      EntityTypes @relation(fields: [entity_type_id], references: [id])
  
  // معلومات إضافية
  description      String?  // وصف مختصر
  full_bio         String?  // السيرة الكاملة
  image_url        String?  // صورة الكيان
  
  // روابط خارجية
  wikipedia_url    String?
  twitter_handle   String?
  linkedin_url     String?
  instagram_handle String?
  official_website String?
  
  // معلومات التصنيف
  category         String?  // تصنيف فرعي
  importance_score Int      @default(1) // 1-10 للترتيب حسب الأهمية
  is_active        Boolean  @default(true)
  
  // تواريخ
  birth_date       DateTime?
  start_date       DateTime? // تاريخ بداية المشروع/المنصب
  end_date         DateTime? // تاريخ النهاية
  
  // موقع جغرافي
  location         String?
  country          String?  @default("SA")
  region           String?
  
  // معلومات SEO
  slug             String?  @unique
  seo_keywords     String?
  
  // الشعبية والتفاعل
  mention_count    Int      @default(0) // عدد مرات الذكر في المقالات
  click_count      Int      @default(0) // عدد النقرات على الروابط
  last_mentioned   DateTime?
  
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  
  // Relations
  source_links     EntityLinks[] @relation("SourceEntity")
  target_links     EntityLinks[] @relation("TargetEntity")
  smart_links      SmartArticleLinks[]
  
  @@map("smart_entities")
  @@index([entity_type_id])
  @@index([importance_score])
  @@index([mention_count])
}

// جدول الروابط بين الكيانات (علاقات)
model EntityLinks {
  id                String   @id @default(cuid())
  source_entity_id  String
  target_entity_id  String
  relationship_type String   // works_at, member_of, located_in, part_of, etc.
  relationship_ar   String?  // يعمل في، عضو في، يقع في، جزء من
  strength          Int      @default(1) // قوة العلاقة 1-10
  is_active         Boolean  @default(true)
  
  source_entity     SmartEntities @relation("SourceEntity", fields: [source_entity_id], references: [id])
  target_entity     SmartEntities @relation("TargetEntity", fields: [target_entity_id], references: [id])
  
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  @@map("entity_links")
  @@unique([source_entity_id, target_entity_id, relationship_type])
}

// جدول الروابط الذكية في المقالات
model SmartArticleLinks {
  id              String   @id @default(cuid())
  article_id      String   // معرف المقال
  entity_id       String
  
  // معلومات الرابط في النص
  matched_text    String   // النص الذي تم ربطه
  context_before  String?  // السياق قبل الكلمة
  context_after   String?  // السياق بعد الكلمة
  position        Int      // موقع الرابط في النص
  confidence      Float    @default(1.0) // مستوى الثقة في الربط
  
  // نوع الرابط
  link_type       String   // entity, tooltip, modal, external
  target_url      String?  // الرابط المستهدف
  tooltip_content String?  // محتوى tooltip
  
  // حالة الرابط
  is_approved     Boolean  @default(false) // موافقة المحرر
  is_active       Boolean  @default(true)
  auto_generated  Boolean  @default(true)  // تم إنشاؤه تلقائياً
  
  // إحصائيات
  clicks          Int      @default(0)
  impressions     Int      @default(0)
  last_clicked    DateTime?
  
  entity          SmartEntities @relation(fields: [entity_id], references: [id])
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  @@map("smart_article_links")
  @@index([article_id])
  @@index([entity_id])
  @@index([is_approved])
}

// جدول المصطلحات والتعاريف
model SmartTerms {
  id              String   @id @default(cuid())
  term            String   @unique
  term_ar         String?
  term_en         String?
  
  definition      String   // التعريف المختصر
  detailed_def    String?  // التعريف المفصل
  example         String?  // مثال على الاستخدام
  
  category        String?  // اقتصادي، سياسي، تقني، طبي
  difficulty      String   @default("medium") // easy, medium, hard
  
  // مرادفات
  synonyms        Json?    // ["الناتج المحلي", "GDP", "إجمالي الناتج المحلي"]
  
  // روابط خارجية
  reference_url   String?
  wikipedia_url   String?
  
  usage_count     Int      @default(0)
  is_active       Boolean  @default(true)
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  
  @@map("smart_terms")
  @@index([category])
  @@index([usage_count])
}

// جدول تتبع أداء الروابط الذكية
model LinkAnalytics {
  id              String   @id @default(cuid())
  link_id         String?  // معرف الرابط الذكي
  article_id      String
  entity_id       String?
  
  // نوع الحدث
  event_type      String   // click, impression, hover, copy
  
  // معلومات المستخدم (مجهولة)
  user_agent      String?
  ip_hash         String?  // hash للـ IP
  session_id      String?
  
  // معلومات السياق
  referrer        String?
  time_on_page    Int?     // بالثواني
  scroll_depth    Float?   // 0.0 - 1.0
  
  // معلومات الجهاز
  device_type     String?  // mobile, desktop, tablet
  browser_type    String?
  
  timestamp       DateTime @default(now())
  
  @@map("link_analytics")
  @@index([article_id])
  @@index([entity_id])
  @@index([event_type])
  @@index([timestamp])
} 