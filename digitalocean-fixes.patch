From 9fe66d7b0b5763ad7c383eb42585c16f1594dc81 Mon Sep 17 00:00:00 2001
From: Ali Alhazmi <ali@sabq.ai>
Date: Wed, 16 Jul 2025 09:53:58 +0300
Subject: [PATCH] =?UTF-8?q?=D8=A5=D8=B5=D9=84=D8=A7=D8=AD:=20=D8=AA=D8=AD?=
 =?UTF-8?q?=D8=AF=D9=8A=D8=AB=20Prisma=20Schema=20=D9=88=D8=A7=D9=84=D8=B9?=
 =?UTF-8?q?=D9=84=D8=A7=D9=82=D8=A7=D8=AA=20=D9=85=D9=86=20categories=20?=
 =?UTF-8?q?=D8=A5=D9=84=D9=89=20category=20=D9=84=D8=AF=D8=B9=D9=85=20Digi?=
 =?UTF-8?q?talOcean?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 app/api/articles/[id]/route.ts         |  12 +-
 app/api/articles/personalized/route.ts |  10 +-
 app/api/articles/route.ts              |  16 +-
 prisma/schema.prisma                   | 475 ++++++++-----------------
 4 files changed, 167 insertions(+), 346 deletions(-)

diff --git a/app/api/articles/[id]/route.ts b/app/api/articles/[id]/route.ts
index f49a73e..26412f0 100644
--- a/app/api/articles/[id]/route.ts
+++ b/app/api/articles/[id]/route.ts
@@ -45,7 +45,7 @@ export async function GET(
         ]
       },
       include: {
-        categories: {
+        category: {
           select: {
             id: true,
             name: true,
@@ -118,9 +118,9 @@ export async function GET(
       },
       author_name: author?.name || (dbArticle.metadata as any)?.author_name || 'غير محدد',
       // إضافة بيانات التصنيف
-      category: dbArticle.categories || null,
-      category_name: dbArticle.categories?.name || 'غير مصنف',
-      category_color: dbArticle.categories?.color || '#6B7280'
+      category: dbArticle.category || null,
+      category_name: dbArticle.category?.name || 'غير مصنف',
+      category_color: dbArticle.category?.color || '#6B7280'
     };
     
     // زيادة عدد المشاهدات بشكل غير متزامن
@@ -202,7 +202,7 @@ export async function PATCH(
     }
 
     if (category_id) {
-      dataToUpdate.categories = {
+      dataToUpdate.category = {
         connect: { id: category_id },
       };
     }
@@ -337,7 +337,7 @@ export async function PUT(
 
     // معالجة category_id
     if (body.category_id) {
-      updateData.categories = {
+      updateData.category = {
         connect: { id: body.category_id }
       };
     }
diff --git a/app/api/articles/personalized/route.ts b/app/api/articles/personalized/route.ts
index a99897b..6a7d4e5 100644
--- a/app/api/articles/personalized/route.ts
+++ b/app/api/articles/personalized/route.ts
@@ -23,12 +23,10 @@ export async function GET(request: NextRequest) {
     }
 
     // جلب اهتمامات المستخدم المحفوظة
-    const savedPreference = await prisma.user_preferences.findUnique({
+    const savedPreference = await prisma.user_preferences.findFirst({
       where: {
-        user_id_key: {
-          user_id: userId,
-          key: 'selected_categories'
-        }
+        user_id: userId,
+        key: 'selected_categories'
       }
     });
 
@@ -85,7 +83,7 @@ export async function GET(request: NextRequest) {
         category_id: { in: categoryIds }
       },
       include: {
-        categories: { select: { id: true, name: true, slug: true } }
+        category: { select: { id: true, name: true, slug: true } }
       },
       orderBy: [
         { featured: 'desc' },
diff --git a/app/api/articles/route.ts b/app/api/articles/route.ts
index 51aac9f..b243f5d 100644
--- a/app/api/articles/route.ts
+++ b/app/api/articles/route.ts
@@ -220,7 +220,7 @@ export async function GET(request: NextRequest) {
           seo_title: true,
           seo_description: true,
           // العلاقات
-          categories: {
+          category: {
             select: {
               id: true,
               name: true,
@@ -279,7 +279,7 @@ export async function GET(request: NextRequest) {
                         'غير محدد'
       
       // التصنيف يأتي مباشرة من include
-      const category = article.categories || null
+      const category = article.category || null
       
       return {
         ...article,
@@ -415,7 +415,14 @@ export async function POST(request: NextRequest) {
         slug: generateSlug(title),
         views: 0,
         reading_time: Math.ceil(content.split(' ').length / 200), // تقدير وقت القراءة
-        updated_at: new Date()
+        updated_at: new Date(),
+        featured: false,
+        breaking: false,
+        allow_comments: true,
+        created_at: new Date(),
+        likes: 0,
+        saves: 0,
+        shares: 0
       }
     })
 
@@ -437,7 +444,8 @@ export async function POST(request: NextRequest) {
               featured_image: featured_image,
               is_breaking: (metadata as any)?.is_breaking || false
             },
-            created_at: new Date()
+            created_at: new Date(),
+            is_important: false
           }
         })
         console.log('✅ تم إضافة الحدث إلى timeline_events')
diff --git a/prisma/schema.prisma b/prisma/schema.prisma
index dd376b8..c35d894 100644
--- a/prisma/schema.prisma
+++ b/prisma/schema.prisma
@@ -5,69 +5,53 @@ generator client {
 }
 
 datasource db {
-  provider  = "postgresql"
-  url       = env("DATABASE_URL")
-  directUrl = env("DIRECT_URL")
+  provider = "postgresql"
+  url      = env("DATABASE_URL")
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model EmailTemplate {
-  id           String
-  name         String   @db.VarChar(255)
-  subject      String   @db.VarChar(500)
-  html_content String
-  text_content String?
-  metadata     Json?
-  created_at   DateTime @db.Timestamp(6)
-  updated_at   DateTime @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model activity_logs {
-  id          String
-  user_id     String?
-  action      String
-  entity_type String?
-  entity_id   String?
-  old_value   Json?
-  new_value   Json?
-  metadata    Json?
-  ip_address  String?  @db.VarChar(45)
-  user_agent  String?
-  created_at  DateTime @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model analytics_data {
-  id           String
-  date         DateTime @db.Date
-  metric_name  String   @db.VarChar(100)
-  metric_value Decimal  @db.Decimal
-  dimensions   Json?
-  metadata     Json?
-  created_at   DateTime @db.Timestamp(6)
-
-  @@ignore
+model users {
+  id                 String   @id
+  email              String
+  password_hash      String?
+  name               String?
+  avatar             String?
+  role               String
+  is_admin           Boolean
+  is_verified        Boolean
+  verification_token String?
+  reset_token        String?
+  reset_token_expiry DateTime? @db.Timestamp(6)
+  created_at         DateTime  @db.Timestamp(6)
+  updated_at         DateTime  @db.Timestamp(6)
+  
+  // علاقات
+  articles           articles[]
+  comments           comments[]
+  loyalty_points     loyalty_points[]
+  activity_logs      activity_logs[]
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model article_keywords {
-  id         String
-  article_id String
-  keyword_id String
-  created_at DateTime @db.Timestamp(6)
-
-  @@ignore
+model categories {
+  id            String   @id
+  name          String
+  slug          String
+  description   String?
+  display_order Int
+  is_active     Boolean
+  color         String?  @db.VarChar(50)
+  icon          String?  @db.VarChar(50)
+  metadata      Json?
+  name_en       String?
+  parent_id     String?
+  created_at    DateTime @db.Timestamp(6)
+  updated_at    DateTime @db.Timestamp(6)
+  
+  // علاقات
+  articles      articles[]
 }
 
-/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model articles {
-  id                String
+  id                String    @id
   title             String    @db.VarChar(500)
   slug              String    @db.VarChar(500)
   content           String
@@ -94,33 +78,17 @@ model articles {
   likes             Int
   saves             Int
   shares            Int
-
+  
+  // علاقات
+  author            users             @relation(fields: [author_id], references: [id])
+  category          categories?       @relation(fields: [category_id], references: [id])
+  comments          comments[]
+  deep_analyses     deep_analyses[]
   @@map("articles")
-  @@ignore
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model categories {
-  id            String
-  name          String
-  slug          String
-  description   String?
-  display_order Int
-  is_active     Boolean
-  color         String?  @db.VarChar(50)
-  icon          String?  @db.VarChar(50)
-  metadata      Json?
-  name_en       String?
-  parent_id     String?
-  created_at    DateTime @db.Timestamp(6)
-  updated_at    DateTime @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model comments {
-  id         String
+  id         String   @id
   article_id String
   user_id    String?
   parent_id  String?
@@ -130,13 +98,30 @@ model comments {
   metadata   Json?
   created_at DateTime @db.Timestamp(6)
   updated_at DateTime @db.Timestamp(6)
+  
+  // علاقات
+  article    articles? @relation(fields: [article_id], references: [id])
+  user       users?    @relation(fields: [user_id], references: [id])
+  parent     comments? @relation("CommentReplies", fields: [parent_id], references: [id])
+  replies    comments[] @relation("CommentReplies")
+}
 
-  @@ignore
+model loyalty_points {
+  id             String   @id
+  user_id        String
+  points         Int
+  action         String   @db.VarChar(100)
+  reference_id   String?
+  reference_type String?
+  metadata       Json?
+  created_at     DateTime @db.Timestamp(6)
+  
+  // علاقات
+  user           users    @relation(fields: [user_id], references: [id])
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model deep_analyses {
-  id                  String
+  id                  String   @id
   article_id          String
   ai_summary          String?
   key_topics          Json?
@@ -149,138 +134,68 @@ model deep_analyses {
   metadata            Json?
   analyzed_at         DateTime @db.Timestamp(6)
   updated_at          DateTime @db.Timestamp(6)
-
-  @@ignore
+  
+  // علاقات
+  article             articles @relation(fields: [article_id], references: [id])
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model email_verification_codes {
-  id         String
-  email      String    @db.VarChar(255)
-  code       String    @db.VarChar(6)
-  user_id    String?
-  expires_at DateTime  @db.Timestamp(6)
-  used_at    DateTime? @db.Timestamp(6)
-  created_at DateTime  @db.Timestamp(6)
-
-  @@ignore
+model activity_logs {
+  id          String   @id
+  user_id     String?
+  action      String
+  entity_type String?
+  entity_id   String?
+  old_value   Json?
+  new_value   Json?
+  metadata    Json?
+  ip_address  String?  @db.VarChar(45)
+  user_agent  String?
+  created_at  DateTime @db.Timestamp(6)
+  
+  // علاقات
+  user        users?   @relation(fields: [user_id], references: [id])
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model forum_badges {
-  id           String
-  name         String    @db.VarChar(255)
-  name_ar      String    @db.VarChar(255)
+model roles {
+  id           String   @id
+  name         String   @db.VarChar(100)
+  slug         String?
+  display_name String?
   description  String?
-  icon         String?   @db.VarChar(50)
-  color        String?   @db.VarChar(50)
-  requirements Json?
-  points       Int?
-  is_active    Boolean?
-  created_at   DateTime? @db.Timestamp(6)
-  updated_at   DateTime? @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model forum_categories {
-  id            String
-  name          String    @db.VarChar(255)
-  name_ar       String    @db.VarChar(255)
-  slug          String    @db.VarChar(255)
-  description   String?
-  icon          String?   @db.VarChar(50)
-  color         String?   @db.VarChar(50)
-  display_order Int?
-  is_active     Boolean?
-  created_at    DateTime? @db.Timestamp(6)
-  updated_at    DateTime? @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model forum_notifications {
-  id          String
-  user_id     String
-  type        String    @db.VarChar(50)
-  target_type String?   @db.VarChar(50)
-  target_id   String?
-  data        Json?
-  is_read     Boolean?
-  created_at  DateTime? @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model forum_reputation {
-  id          String
-  user_id     String
-  points      Int?
-  action_type String    @db.VarChar(50)
-  target_type String?   @db.VarChar(50)
-  target_id   String?
-  description String?
-  created_at  DateTime? @db.Timestamp(6)
-
-  @@ignore
+  permissions  Json?
+  is_system    Boolean
+  created_at   DateTime @db.Timestamp(6)
+  updated_at   DateTime @db.Timestamp(6)
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model forum_user_badges {
-  id        String
-  user_id   String
-  badge_id  String
-  earned_at DateTime? @db.Timestamp(6)
-
-  @@ignore
+model user_preferences {
+  id         String   @id
+  user_id    String
+  key        String
+  value      Json
+  created_at DateTime @db.Timestamp(6)
+  updated_at DateTime @db.Timestamp(6)
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model home_blocks_config {
-  id            String
-  block_type    String   @db.VarChar(50)
-  title         String   @db.VarChar(255)
-  subtitle      String?  @db.VarChar(255)
-  settings      Json
-  display_order Int
-  is_active     Boolean
-  created_at    DateTime @db.Timestamp(6)
-  updated_at    DateTime @db.Timestamp(6)
-
-  @@ignore
+model user_roles {
+  id         String    @id
+  user_id    String
+  role_id    String
+  granted_by String?
+  granted_at DateTime  @db.Timestamp(6)
+  expires_at DateTime? @db.Timestamp(6)
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model keywords {
-  id         String
+  id         String   @id
   name       String
   slug       String
   count      Int
   created_at DateTime @db.Timestamp(6)
-
-  @@ignore
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model loyalty_points {
-  id             String
-  user_id        String
-  points         Int
-  action         String   @db.VarChar(100)
-  reference_id   String?
-  reference_type String?
-  metadata       Json?
-  created_at     DateTime @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model messages {
-  id            String
+  id            String    @id
   from_user_id  String?
   to_user_id    String?
   email         String
@@ -291,13 +206,10 @@ model messages {
   reply_content String?
   metadata      Json?
   created_at    DateTime  @db.Timestamp(6)
-
-  @@ignore
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model timeline_events {
-  id             String
+  id             String   @id
   event_type     String   @db.VarChar(50)
   entity_type    String   @db.VarChar(50)
   entity_id      String?
@@ -313,52 +225,26 @@ model timeline_events {
   metadata       Json?
   is_important   Boolean
   created_at     DateTime @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model password_reset_tokens {
-  id         String
-  user_id    String
-  token      String    @db.VarChar(255)
-  expires_at DateTime  @db.Timestamp(6)
-  used_at    DateTime? @db.Timestamp(6)
-  created_at DateTime  @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model roles {
-  id           String
-  name         String   @db.VarChar(100)
-  slug         String?
-  display_name String?
-  description  String?
-  permissions  Json?
-  is_system    Boolean
-  created_at   DateTime @db.Timestamp(6)
-  updated_at   DateTime @db.Timestamp(6)
-
-  @@ignore
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model site_settings {
-  id         String
-  section    String   @db.VarChar(50)
-  data       Json
-  created_at DateTime @db.Timestamp(6)
-  updated_at DateTime @db.Timestamp(6)
-
-  @@ignore
+model team_members {
+  id            String   @id
+  name          String   @db.VarChar(255)
+  role          String   @db.VarChar(100)
+  department    String?  @db.VarChar(100)
+  bio           String?
+  avatar        String?
+  email         String?  @db.VarChar(255)
+  phone         String?  @db.VarChar(50)
+  social_links  Json?
+  is_active     Boolean
+  display_order Int
+  created_at    DateTime @db.Timestamp(6)
+  updated_at    DateTime @db.Timestamp(6)
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model smart_blocks {
-  id            String
+  id            String    @id
   name          String    @db.VarChar(255)
   type          String    @db.VarChar(50)
   config        Json
@@ -369,44 +255,30 @@ model smart_blocks {
   performance   Json?
   created_at    DateTime  @db.Timestamp(6)
   updated_at    DateTime  @db.Timestamp(6)
-
-  @@ignore
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model team_members {
-  id            String
-  name          String   @db.VarChar(255)
-  role          String   @db.VarChar(100)
-  department    String?  @db.VarChar(100)
-  bio           String?
-  avatar        String?
-  email         String?  @db.VarChar(255)
-  phone         String?  @db.VarChar(50)
-  social_links  Json?
-  is_active     Boolean
+model home_blocks_config {
+  id            String   @id
+  block_type    String   @db.VarChar(50)
+  title         String   @db.VarChar(255)
+  subtitle      String?  @db.VarChar(255)
+  settings      Json
   display_order Int
+  is_active     Boolean
   created_at    DateTime @db.Timestamp(6)
   updated_at    DateTime @db.Timestamp(6)
-
-  @@ignore
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model template_previews {
-  id          String
-  template_id String
-  title       String   @db.VarChar(500)
-  content     String
-  metadata    Json?
-  created_at  DateTime @db.Timestamp(6)
-
-  @@ignore
+model site_settings {
+  id         String   @id
+  section    String   @db.VarChar(50)
+  data       Json
+  created_at DateTime @db.Timestamp(6)
+  updated_at DateTime @db.Timestamp(6)
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model templates {
-  id           String
+  id           String   @id
   name         String   @db.VarChar(255)
   slug         String   @db.VarChar(255)
   description  String?
@@ -419,56 +291,10 @@ model templates {
   created_by   String?
   created_at   DateTime @db.Timestamp(6)
   updated_at   DateTime @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model user_preferences {
-  id         String
-  user_id    String
-  key        String
-  value      Json
-  created_at DateTime @db.Timestamp(6)
-  updated_at DateTime @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model user_roles {
-  id         String
-  user_id    String
-  role_id    String
-  granted_by String?
-  granted_at DateTime  @db.Timestamp(6)
-  expires_at DateTime? @db.Timestamp(6)
-
-  @@ignore
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
-model users {
-  id                 String
-  email              String
-  password_hash      String?
-  name               String?
-  avatar             String?
-  role               String
-  is_admin           Boolean
-  is_verified        Boolean
-  verification_token String?
-  reset_token        String?
-  reset_token_expiry DateTime? @db.Timestamp(6)
-  created_at         DateTime  @db.Timestamp(6)
-  updated_at         DateTime  @db.Timestamp(6)
-
-  @@ignore
-}
-
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model was_news {
-  id               String   @default(uuid())
+  id               String   @id @default(uuid())
   news_NUM         Int
   news_DT          DateTime @db.Timestamp(6)
   news_basket_CD   Int
@@ -485,13 +311,10 @@ model was_news {
   imported_to_id   String?
   created_at       DateTime @db.Timestamp(6)
   updated_at       DateTime @db.Timestamp(6)
-
-  @@ignore
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model user_reading_sessions {
-  id               String    @db.VarChar(36)
+  id               String    @id @db.VarChar(36)
   user_id          String    @db.VarChar(36)
   article_id       String    @db.VarChar(36)
   started_at       DateTime? @db.Timestamptz(6)
@@ -502,13 +325,10 @@ model user_reading_sessions {
   device_type      String?   @db.VarChar(50)
   time_of_day      Int?
   created_at       DateTime? @db.Timestamptz(6)
-
-  @@ignore
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model user_insights {
-  id                      String    @db.VarChar(36)
+  id                      String    @id @db.VarChar(36)
   user_id                 String    @db.VarChar(36)
   total_reads             Int?
   total_saved             Int?
@@ -525,18 +345,13 @@ model user_insights {
   last_read_date          DateTime? @db.Timestamptz(6)
   calculated_at           DateTime? @db.Timestamptz(6)
   updated_at              DateTime? @updatedAt @db.Timestamptz(6)
-
-  @@ignore
 }
 
-/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
 model user_similar_readers {
-  id                String    @db.VarChar(36)
+  id                String    @id @db.VarChar(36)
   user_id           String    @db.VarChar(36)
   similar_user_id   String    @db.VarChar(36)
   similarity_score  Float?
   common_categories Json?
   calculated_at     DateTime? @db.Timestamptz(6)
-
-  @@ignore
-}
+} 
\ No newline at end of file
-- 
2.39.5 (Apple Git-154)

