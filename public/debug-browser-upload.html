<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ´Ø®ÙŠØµ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ø¨Ø±Ø§ÙˆØ²Ø±</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            direction: rtl;
        }
        .test-section { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #e2e3e5; border-color: #d6d8db; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            overflow-x: auto;
            direction: ltr;
        }
        input[type="file"] { margin: 10px 0; }
        .log-container { 
            max-height: 300px; 
            overflow-y: auto; 
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            direction: ltr;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ØªØ´Ø®ÙŠØµ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ø¨Ø±Ø§ÙˆØ²Ø±</h1>
    
    <div class="test-section info">
        <h3>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©</h3>
        <div id="environment-info"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ù€ APIs</h3>
        <button onclick="testAllEndpoints()">Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</button>
        <div id="api-test-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù Ø­Ù‚ÙŠÙ‚ÙŠ</h3>
        <input type="file" id="file-input" accept="image/*">
        <br>
        <button onclick="uploadWithOriginalFetch()">Ø±ÙØ¹ Ø¨Ù€ fetch Ø§Ù„Ø£ØµÙ„ÙŠ</button>
        <button onclick="uploadWithCurrentFetch()">Ø±ÙØ¹ Ø¨Ù€ fetch Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
        <button onclick="uploadWithSafeMethod()">Ø±ÙØ¹ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø©</button>
        <div id="upload-results"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
        <button onclick="clearLog()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
        <div id="log-container" class="log-container"></div>
    </div>

    <script src="/emergency-fixes.js"></script>
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…
        const ENDPOINTS = [
            '/api/upload-image-safe',
            '/api/upload',
            '/api/upload-image'
        ];

        let originalFetch = null;

        // Ø­ÙØ¸ fetch Ø§Ù„Ø£ØµÙ„ÙŠ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ
        (function() {
            originalFetch = window.fetch.bind(window);
        })();

        // Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¬Ù„
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const entry = document.createElement('div');
            entry.style.marginBottom = '5px';
            entry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
        }

        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
        function showEnvironmentInfo() {
            const info = document.getElementById('environment-info');
            const userAgent = navigator.userAgent;
            const isEmergencyFixesLoaded = typeof window.fetch !== 'undefined' && window.fetch.toString().includes('emergency');
            
            info.innerHTML = `
                <p><strong>Ø§Ù„Ù…ØªØµÙØ­:</strong> ${userAgent}</p>
                <p><strong>emergency-fixes Ù…Ø­Ù…Ù„:</strong> ${isEmergencyFixesLoaded ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</p>
                <p><strong>fetch Ù…ÙØ¹Ø±Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹:</strong> ${window.fetch !== originalFetch ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</p>
                <p><strong>FormData Ù…ØªØ§Ø­:</strong> ${typeof FormData !== 'undefined' ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§'}</p>
            `;
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        async function testAllEndpoints() {
            const resultsDiv = document.getElementById('api-test-results');
            resultsDiv.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</p>';
            log('Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§ÙŠØ©');

            const results = [];

            for (const endpoint of ENDPOINTS) {
                try {
                    log(`Ø§Ø®ØªØ¨Ø§Ø± ${endpoint}...`);
                    const response = await fetch(endpoint, { method: 'GET' });
                    const data = await response.json();
                    
                    results.push({
                        endpoint,
                        status: response.status,
                        success: response.ok,
                        data
                    });
                    
                    log(`${endpoint}: ${response.status} ${response.ok ? 'âœ…' : 'âŒ'}`, response.ok ? 'success' : 'error');
                } catch (error) {
                    results.push({
                        endpoint,
                        status: 'ERROR',
                        success: false,
                        error: error.message
                    });
                    log(`${endpoint}: Ø®Ø·Ø£ - ${error.message}`, 'error');
                }
            }

            resultsDiv.innerHTML = results.map(result => `
                <div class="${result.success ? 'success' : 'error'}" style="margin: 5px 0; padding: 8px; border-radius: 3px;">
                    <strong>${result.endpoint}</strong>: ${result.status} 
                    ${result.success ? 'âœ…' : 'âŒ'}
                    ${result.error ? `<br>Ø®Ø·Ø£: ${result.error}` : ''}
                </div>
            `).join('');
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ø®ØªØ¨Ø§Ø± ØµØºÙŠØ±
        function createTestFile() {
            const canvas = document.createElement('canvas');
            canvas.width = 10;
            canvas.height = 10;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(0, 0, 10, 10);

            return new Promise(resolve => {
                canvas.toBlob(blob => {
                    const file = new File([blob], 'test-image.png', { type: 'image/png' });
                    resolve(file);
                }, 'image/png');
            });
        }

        // Ø±ÙØ¹ Ø¨Ù€ fetch Ø§Ù„Ø£ØµÙ„ÙŠ
        async function uploadWithOriginalFetch() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0] || await createTestFile();
            
            log('Ø±ÙØ¹ Ø¨Ù€ fetch Ø§Ù„Ø£ØµÙ„ÙŠ...');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', 'general');

                log('FormData ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§');

                const response = await originalFetch('/api/upload-image-safe', {
                    method: 'POST',
                    body: formData
                });

                log(`Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${response.status}`);

                const result = await response.json();
                log(`Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${JSON.stringify(result)}`, response.ok ? 'success' : 'error');

                displayUploadResult('fetch Ø§Ù„Ø£ØµÙ„ÙŠ', response.ok, result);

            } catch (error) {
                log(`Ø®Ø·Ø£ ÙÙŠ fetch Ø§Ù„Ø£ØµÙ„ÙŠ: ${error.message}`, 'error');
                displayUploadResult('fetch Ø§Ù„Ø£ØµÙ„ÙŠ', false, { error: error.message });
            }
        }

        // Ø±ÙØ¹ Ø¨Ù€ fetch Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ù…ÙØ¹Ø±Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹)
        async function uploadWithCurrentFetch() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0] || await createTestFile();
            
            log('Ø±ÙØ¹ Ø¨Ù€ fetch Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ù„Ù…ÙØ¹Ø±Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹)...');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', 'general');

                log('FormData ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§');

                const response = await fetch('/api/upload-image-safe', {
                    method: 'POST',
                    body: formData
                });

                log(`Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${response.status}`);

                const result = await response.json();
                log(`Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${JSON.stringify(result)}`, response.ok ? 'success' : 'error');

                displayUploadResult('fetch Ø§Ù„Ø­Ø§Ù„ÙŠ', response.ok, result);

            } catch (error) {
                log(`Ø®Ø·Ø£ ÙÙŠ fetch Ø§Ù„Ø­Ø§Ù„ÙŠ: ${error.message}`, 'error');
                displayUploadResult('fetch Ø§Ù„Ø­Ø§Ù„ÙŠ', false, { error: error.message });
            }
        }

        // Ø±ÙØ¹ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø© (Ø§Ø³ØªØ®Ø¯Ø§Ù… safe-upload library)
        async function uploadWithSafeMethod() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0] || await createTestFile();
            
            log('Ø±ÙØ¹ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø©...');
            
            try {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… safe-upload Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
                if (window.safeUpload && window.safeUpload.uploadImage) {
                    const result = await window.safeUpload.uploadImage(file, 'general');
                    log(`Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¢Ù…Ù†Ø©: ${JSON.stringify(result)}`, 'success');
                    displayUploadResult('Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø©', true, result);
                } else {
                    log('safe-upload ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch Ù…Ø¨Ø§Ø´Ø±');
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('type', 'general');

                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… XMLHttpRequest Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† fetch
                    const xhr = new XMLHttpRequest();
                    
                    xhr.open('POST', '/api/upload-image-safe');
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            const result = JSON.parse(xhr.responseText);
                            log(`XHR Ù†Ø¬Ø­: ${JSON.stringify(result)}`, 'success');
                            displayUploadResult('XHR', true, result);
                        } else {
                            log(`XHR ÙØ´Ù„: ${xhr.status} - ${xhr.responseText}`, 'error');
                            displayUploadResult('XHR', false, { error: xhr.responseText });
                        }
                    };
                    
                    xhr.onerror = function() {
                        log(`XHR Ø®Ø·Ø£: ${xhr.statusText}`, 'error');
                        displayUploadResult('XHR', false, { error: xhr.statusText });
                    };
                    
                    xhr.send(formData);
                }

            } catch (error) {
                log(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø©: ${error.message}`, 'error');
                displayUploadResult('Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù…Ù†Ø©', false, { error: error.message });
            }
        }

        function displayUploadResult(method, success, result) {
            const resultsDiv = document.getElementById('upload-results');
            const resultElement = document.createElement('div');
            resultElement.className = `test-section ${success ? 'success' : 'error'}`;
            resultElement.innerHTML = `
                <h4>${method}: ${success ? 'âœ… Ù†Ø¬Ø­' : 'âŒ ÙØ´Ù„'}</h4>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
            resultsDiv.appendChild(resultElement);
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            showEnvironmentInfo();
            log('ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ');
        });
    </script>
</body>
</html>
