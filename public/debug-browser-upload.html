<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تشخيص رفع الصور من البراوزر</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            direction: rtl;
        }
        .test-section { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #e2e3e5; border-color: #d6d8db; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            overflow-x: auto;
            direction: ltr;
        }
        input[type="file"] { margin: 10px 0; }
        .log-container { 
            max-height: 300px; 
            overflow-y: auto; 
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            direction: ltr;
        }
    </style>
</head>
<body>
    <h1>🔍 تشخيص رفع الصور من البراوزر</h1>
    
    <div class="test-section info">
        <h3>📋 معلومات البيئة</h3>
        <div id="environment-info"></div>
    </div>

    <div class="test-section">
        <h3>🧪 اختبار سريع للـ APIs</h3>
        <button onclick="testAllEndpoints()">اختبار جميع نقاط النهاية</button>
        <div id="api-test-results"></div>
    </div>

    <div class="test-section">
        <h3>📤 رفع ملف حقيقي</h3>
        <input type="file" id="file-input" accept="image/*">
        <br>
        <button onclick="uploadWithOriginalFetch()">رفع بـ fetch الأصلي</button>
        <button onclick="uploadWithCurrentFetch()">رفع بـ fetch الحالي</button>
        <button onclick="uploadWithSafeMethod()">رفع بالطريقة الآمنة</button>
        <div id="upload-results"></div>
    </div>

    <div class="test-section">
        <h3>📜 سجل العمليات</h3>
        <button onclick="clearLog()">مسح السجل</button>
        <div id="log-container" class="log-container"></div>
    </div>

    <script src="/emergency-fixes.js"></script>
    <script>
        // إعداد النظام
        const ENDPOINTS = [
            '/api/upload-image-safe',
            '/api/upload',
            '/api/upload-image'
        ];

        let originalFetch = null;

        // حفظ fetch الأصلي قبل إعادة التعريف
        (function() {
            originalFetch = window.fetch.bind(window);
        })();

        // نظام السجل
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const entry = document.createElement('div');
            entry.style.marginBottom = '5px';
            entry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
        }

        // عرض معلومات البيئة
        function showEnvironmentInfo() {
            const info = document.getElementById('environment-info');
            const userAgent = navigator.userAgent;
            const isEmergencyFixesLoaded = typeof window.fetch !== 'undefined' && window.fetch.toString().includes('emergency');
            
            info.innerHTML = `
                <p><strong>المتصفح:</strong> ${userAgent}</p>
                <p><strong>emergency-fixes محمل:</strong> ${isEmergencyFixesLoaded ? '✅ نعم' : '❌ لا'}</p>
                <p><strong>fetch مُعرف مسبقاً:</strong> ${window.fetch !== originalFetch ? '✅ نعم' : '❌ لا'}</p>
                <p><strong>FormData متاح:</strong> ${typeof FormData !== 'undefined' ? '✅ نعم' : '❌ لا'}</p>
            `;
        }

        // اختبار نقاط النهاية
        async function testAllEndpoints() {
            const resultsDiv = document.getElementById('api-test-results');
            resultsDiv.innerHTML = '<p>جاري الاختبار...</p>';
            log('بدء اختبار نقاط النهاية');

            const results = [];

            for (const endpoint of ENDPOINTS) {
                try {
                    log(`اختبار ${endpoint}...`);
                    const response = await fetch(endpoint, { method: 'GET' });
                    const data = await response.json();
                    
                    results.push({
                        endpoint,
                        status: response.status,
                        success: response.ok,
                        data
                    });
                    
                    log(`${endpoint}: ${response.status} ${response.ok ? '✅' : '❌'}`, response.ok ? 'success' : 'error');
                } catch (error) {
                    results.push({
                        endpoint,
                        status: 'ERROR',
                        success: false,
                        error: error.message
                    });
                    log(`${endpoint}: خطأ - ${error.message}`, 'error');
                }
            }

            resultsDiv.innerHTML = results.map(result => `
                <div class="${result.success ? 'success' : 'error'}" style="margin: 5px 0; padding: 8px; border-radius: 3px;">
                    <strong>${result.endpoint}</strong>: ${result.status} 
                    ${result.success ? '✅' : '❌'}
                    ${result.error ? `<br>خطأ: ${result.error}` : ''}
                </div>
            `).join('');
        }

        // إنشاء ملف اختبار صغير
        function createTestFile() {
            const canvas = document.createElement('canvas');
            canvas.width = 10;
            canvas.height = 10;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(0, 0, 10, 10);

            return new Promise(resolve => {
                canvas.toBlob(blob => {
                    const file = new File([blob], 'test-image.png', { type: 'image/png' });
                    resolve(file);
                }, 'image/png');
            });
        }

        // رفع بـ fetch الأصلي
        async function uploadWithOriginalFetch() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0] || await createTestFile();
            
            log('رفع بـ fetch الأصلي...');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', 'general');

                log('FormData تم إنشاؤها');

                const response = await originalFetch('/api/upload-image-safe', {
                    method: 'POST',
                    body: formData
                });

                log(`الاستجابة: ${response.status}`);

                const result = await response.json();
                log(`النتيجة: ${JSON.stringify(result)}`, response.ok ? 'success' : 'error');

                displayUploadResult('fetch الأصلي', response.ok, result);

            } catch (error) {
                log(`خطأ في fetch الأصلي: ${error.message}`, 'error');
                displayUploadResult('fetch الأصلي', false, { error: error.message });
            }
        }

        // رفع بـ fetch الحالي (المُعرف مسبقاً)
        async function uploadWithCurrentFetch() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0] || await createTestFile();
            
            log('رفع بـ fetch الحالي (المُعرف مسبقاً)...');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', 'general');

                log('FormData تم إنشاؤها');

                const response = await fetch('/api/upload-image-safe', {
                    method: 'POST',
                    body: formData
                });

                log(`الاستجابة: ${response.status}`);

                const result = await response.json();
                log(`النتيجة: ${JSON.stringify(result)}`, response.ok ? 'success' : 'error');

                displayUploadResult('fetch الحالي', response.ok, result);

            } catch (error) {
                log(`خطأ في fetch الحالي: ${error.message}`, 'error');
                displayUploadResult('fetch الحالي', false, { error: error.message });
            }
        }

        // رفع بالطريقة الآمنة (استخدام safe-upload library)
        async function uploadWithSafeMethod() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0] || await createTestFile();
            
            log('رفع بالطريقة الآمنة...');
            
            try {
                // محاولة استخدام safe-upload إذا كان متاحاً
                if (window.safeUpload && window.safeUpload.uploadImage) {
                    const result = await window.safeUpload.uploadImage(file, 'general');
                    log(`النتيجة الآمنة: ${JSON.stringify(result)}`, 'success');
                    displayUploadResult('الطريقة الآمنة', true, result);
                } else {
                    log('safe-upload غير متاح، استخدام fetch مباشر');
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('type', 'general');

                    // استخدام XMLHttpRequest بدلاً من fetch
                    const xhr = new XMLHttpRequest();
                    
                    xhr.open('POST', '/api/upload-image-safe');
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            const result = JSON.parse(xhr.responseText);
                            log(`XHR نجح: ${JSON.stringify(result)}`, 'success');
                            displayUploadResult('XHR', true, result);
                        } else {
                            log(`XHR فشل: ${xhr.status} - ${xhr.responseText}`, 'error');
                            displayUploadResult('XHR', false, { error: xhr.responseText });
                        }
                    };
                    
                    xhr.onerror = function() {
                        log(`XHR خطأ: ${xhr.statusText}`, 'error');
                        displayUploadResult('XHR', false, { error: xhr.statusText });
                    };
                    
                    xhr.send(formData);
                }

            } catch (error) {
                log(`خطأ في الطريقة الآمنة: ${error.message}`, 'error');
                displayUploadResult('الطريقة الآمنة', false, { error: error.message });
            }
        }

        function displayUploadResult(method, success, result) {
            const resultsDiv = document.getElementById('upload-results');
            const resultElement = document.createElement('div');
            resultElement.className = `test-section ${success ? 'success' : 'error'}`;
            resultElement.innerHTML = `
                <h4>${method}: ${success ? '✅ نجح' : '❌ فشل'}</h4>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
            resultsDiv.appendChild(resultElement);
        }

        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            showEnvironmentInfo();
            log('تم تحميل صفحة التشخيص');
        });
    </script>
</body>
</html>
