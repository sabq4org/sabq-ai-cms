#!/usr/bin/env node

/**
 * ØªØ­ÙˆÙŠÙ„ Ù…Ù„Ù SQL Ù…Ù† MySQL Ø¥Ù„Ù‰ PostgreSQL
 * Convert MySQL SQL dump to PostgreSQL compatible format
 */

const fs = require('fs');
const zlib = require('zlib');
const path = require('path');

function convertMySQLToPostgreSQL(sqlContent) {
    console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­ÙˆÙŠÙ„ MySQL syntax Ø¥Ù„Ù‰ PostgreSQL...');
    
    let converted = sqlContent;
    let changes = 0;

    // 1. Ø¥ØµÙ„Ø§Ø­ integer(size) -> integer
    const integerMatches = converted.match(/integer\(\d+,?\d*\)/gi);
    if (integerMatches) {
        console.log(`ğŸ“Š ÙˆØ¬Ø¯Øª ${integerMatches.length} Ù…Ø´ÙƒÙ„Ø© integer(size)`);
        converted = converted.replace(/integer\(\d+,0\)/gi, 'integer');
        converted = converted.replace(/integer\(\d+\)/gi, 'integer');
        changes += integerMatches.length;
    }

    // 2. Ø¥ØµÙ„Ø§Ø­ int(size) -> integer
    const intMatches = converted.match(/\bint\(\d+\)/gi);
    if (intMatches) {
        console.log(`ğŸ“Š ÙˆØ¬Ø¯Øª ${intMatches.length} Ù…Ø´ÙƒÙ„Ø© int(size)`);
        converted = converted.replace(/\bint\(\d+\)/gi, 'integer');
        changes += intMatches.length;
    }

    // 3. Ø¥ØµÙ„Ø§Ø­ tinyint(1) -> boolean
    const tinyintMatches = converted.match(/tinyint\(1\)/gi);
    if (tinyintMatches) {
        console.log(`ğŸ“Š ÙˆØ¬Ø¯Øª ${tinyintMatches.length} Ù…Ø´ÙƒÙ„Ø© tinyint(1)`);
        converted = converted.replace(/tinyint\(1\)/gi, 'boolean');
        changes += tinyintMatches.length;
    }

    // 4. Ø¥Ø²Ø§Ù„Ø© backticks
    const backtickMatches = converted.match(/`[^`]*`/g);
    if (backtickMatches) {
        console.log(`ğŸ“Š ÙˆØ¬Ø¯Øª ${backtickMatches.length} Ù…Ø´ÙƒÙ„Ø© backticks`);
        converted = converted.replace(/`([^`]*)`/g, '"$1"');
        changes += backtickMatches.length;
    }

    // 5. Ø¥ØµÙ„Ø§Ø­ AUTO_INCREMENT
    const autoIncMatches = converted.match(/AUTO_INCREMENT/gi);
    if (autoIncMatches) {
        console.log(`ğŸ“Š ÙˆØ¬Ø¯Øª ${autoIncMatches.length} Ù…Ø´ÙƒÙ„Ø© AUTO_INCREMENT`);
        converted = converted.replace(/AUTO_INCREMENT/gi, 'GENERATED BY DEFAULT AS IDENTITY');
        changes += autoIncMatches.length;
    }

    // 6. Ø¥Ø²Ø§Ù„Ø© ENGINE ÙˆCHARSET
    const engineMatches = converted.match(/ENGINE=[^\s,)]+/gi);
    if (engineMatches) {
        console.log(`ğŸ“Š ÙˆØ¬Ø¯Øª ${engineMatches.length} Ù…Ø´ÙƒÙ„Ø© ENGINE`);
        converted = converted.replace(/ENGINE=[^\s,)]+/gi, '');
        changes += engineMatches.length;
    }

    const charsetMatches = converted.match(/DEFAULT CHARSET=[^\s,)]+/gi);
    if (charsetMatches) {
        console.log(`ğŸ“Š ÙˆØ¬Ø¯Øª ${charsetMatches.length} Ù…Ø´ÙƒÙ„Ø© CHARSET`);
        converted = converted.replace(/DEFAULT CHARSET=[^\s,)]+/gi, '');
        changes += charsetMatches.length;
    }

    // 7. Ø¥Ø²Ø§Ù„Ø© UNSIGNED
    const unsignedMatches = converted.match(/\bUNSIGNED\b/gi);
    if (unsignedMatches) {
        console.log(`ğŸ“Š ÙˆØ¬Ø¯Øª ${unsignedMatches.length} Ù…Ø´ÙƒÙ„Ø© UNSIGNED`);
        converted = converted.replace(/\bUNSIGNED\b/gi, '');
        changes += unsignedMatches.length;
    }

    // 8. ØªØ­ÙˆÙŠÙ„ datetime Ø¥Ù„Ù‰ timestamp
    const datetimeMatches = converted.match(/\bdatetime\b/gi);
    if (datetimeMatches) {
        console.log(`ğŸ“Š ÙˆØ¬Ø¯Øª ${datetimeMatches.length} Ù…Ø´ÙƒÙ„Ø© datetime`);
        converted = converted.replace(/\bdatetime\b/gi, 'timestamp');
        changes += datetimeMatches.length;
    }

    // 9. ØªØ­ÙˆÙŠÙ„ longtext/mediumtext Ø¥Ù„Ù‰ text
    const longtextMatches = converted.match(/\b(longtext|mediumtext)\b/gi);
    if (longtextMatches) {
        console.log(`ğŸ“Š ÙˆØ¬Ø¯Øª ${longtextMatches.length} Ù…Ø´ÙƒÙ„Ø© longtext/mediumtext`);
        converted = converted.replace(/\b(longtext|mediumtext)\b/gi, 'text');
        changes += longtextMatches.length;
    }

    // 10. ØªÙ†Ø¸ÙŠÙ ÙÙˆØ§ØµÙ„ Ø¥Ø¶Ø§ÙÙŠØ©
    converted = converted.replace(/,\s*\)/g, ')');
    converted = converted.replace(/\s+/g, ' ');

    console.log(`âœ… ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ ${changes} ØªØºÙŠÙŠØ± Ù„ØªØ­ÙˆÙŠÙ„ MySQL Ø¥Ù„Ù‰ PostgreSQL`);
    return converted;
}

async function processFile(inputPath, outputPath) {
    console.log(`ğŸ“ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: ${path.basename(inputPath)}`);
    
    try {
        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·
        console.log('ğŸ“¥ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·...');
        const compressedData = fs.readFileSync(inputPath);
        const sqlContent = zlib.gunzipSync(compressedData).toString('utf8');
        
        console.log(`ğŸ“Š Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ: ${(sqlContent.length / 1024 / 1024).toFixed(2)} MB`);
        
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        const convertedContent = convertMySQLToPostgreSQL(sqlContent);
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
        const finalContent = `-- SABQ Database - MySQL to PostgreSQL Converted
-- Converted on: ${new Date().toISOString()}
-- Original file: ${path.basename(inputPath)}
-- Changes: Fixed MySQL syntax for PostgreSQL compatibility

${convertedContent}`;
        
        // Ø¶ØºØ· ÙˆØ­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        console.log('ğŸ“¤ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­ÙˆÙ„...');
        const compressedResult = zlib.gzipSync(finalContent);
        fs.writeFileSync(outputPath, compressedResult);
        
        console.log(`âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸: ${outputPath}`);
        console.log(`ğŸ“Š Ø§Ù„Ø­Ø¬Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ${(finalContent.length / 1024 / 1024).toFixed(2)} MB`);
        console.log(`ğŸ“Š Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ø¶ØºÙˆØ·: ${(compressedResult.length / 1024 / 1024).toFixed(2)} MB`);
        
        return true;
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù:', error.message);
        return false;
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­ÙˆÙ„
async function main() {
    const inputFile = '/Users/alialhazmi/sabq-ai-cms/northflank-backup/sabq-fixed-2025-08-30T20-21-06.sql.gz';
    const outputFile = '/Users/alialhazmi/sabq-ai-cms/northflank-backup/sabq-postgres-converted.sql.gz';
    
    console.log('ğŸš€ SABQ Database - MySQL to PostgreSQL Converter');
    console.log('===============================================\n');
    
    if (!fs.existsSync(inputFile)) {
        console.error('âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', inputFile);
        process.exit(1);
    }
    
    const success = await processFile(inputFile, outputFile);
    
    if (success) {
        console.log('\nğŸ‰ ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
        console.log('ğŸ“ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:');
        console.log(`   ${outputFile}`);
        console.log('\nğŸ“‹ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©:');
        console.log('   Ù‚Ù… Ø¨Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰ Northflank');
    } else {
        console.log('\nâŒ ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„');
        process.exit(1);
    }
}

main();
