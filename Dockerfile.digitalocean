# Digital Ocean Dockerfile Ù…Ø­Ø³Ù† Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
# ØªØ­Ø¯ÙŠØ«: 2025-07-23 - ØªØ­ÙÙŠØ² Ø§Ù„Ù†Ø´Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
FROM node:20-alpine AS base

# ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
FROM base AS deps
RUN apk add --no-cache libc6-compat python3 make g++ vips-dev curl
WORKDIR /app

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø²Ù…
COPY package.json yarn.lock* package-lock.json* pnpm-lock.yaml* ./

# ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
RUN npm config set ignore-scripts true && \
    if [ -f yarn.lock ]; then yarn --frozen-lockfile; \
    elif [ -f package-lock.json ]; then npm install --legacy-peer-deps --ignore-scripts; \
    elif [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm i --frozen-lockfile; \
    else echo "Lockfile not found." && exit 1; \
    fi && \
    npm config set ignore-scripts false

# Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„Ù„Ø¨Ù†Ø§Ø¡
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production
ENV SKIP_EMAIL_VERIFICATION=true
ENV BUILDING=true

# Ù…ØªØºÙŠØ±Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„Ø¨Ù†Ø§Ø¡
ENV DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy?schema=public"
ENV NEXTAUTH_SECRET="build-secret"
ENV JWT_SECRET="build-jwt"
ENV NEXTAUTH_URL="http://localhost:3000"
ENV OPENAI_API_KEY=""
ENV CLOUDINARY_CLOUD_NAME="dummy"
ENV CLOUDINARY_API_KEY="dummy"
ENV CLOUDINARY_API_SECRET="dummy"

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Prisma Client
RUN mkdir -p lib/generated

# ØªØ­Ø¶ÙŠØ± Prisma Ù„Ù„Ø¥Ù†ØªØ§Ø¬
RUN echo "ğŸš€ ØªØ­Ø¶ÙŠØ± Prisma Ù„Ù„Ø¥Ù†ØªØ§Ø¬..." && \
    if [ -f "scripts/prepare-prisma-for-production.js" ]; then \
        node scripts/prepare-prisma-for-production.js; \
    fi

# ØªÙˆÙ„ÙŠØ¯ Prisma Client
RUN echo "ğŸ”§ ØªÙˆÙ„ÙŠØ¯ Prisma Client..." && \
    npx prisma generate && \
    echo "âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ Prisma Client"

# Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
RUN echo "ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ Next.js..." && \
    if [ -f "scripts/digitalocean-build-v5.js" ]; then \
        chmod +x scripts/digitalocean-build-v5.js && \
        node scripts/digitalocean-build-v5.js; \
    else \
        npx next build; \
    fi

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† BUILD_ID
RUN echo "ğŸ†” ÙØ­Øµ BUILD_ID..." && \
    if [ ! -f ".next/BUILD_ID" ]; then \
        echo "âŒ BUILD_ID Ù…ÙÙ‚ÙˆØ¯! Ø¨Ù†Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±..." && \
        npx next build; \
    fi && \
    echo "âœ… BUILD_ID: $(cat .next/BUILD_ID 2>/dev/null || echo 'none')"

# ØµÙˆØ±Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME=0.0.0.0

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… nodejs
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
COPY --from=builder /app/public ./public

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ .next
RUN mkdir .next && chown nextjs:nodejs .next

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next
COPY --from=builder --chown=nextjs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nextjs:nodejs /app/package.json ./package.json
COPY --from=builder --chown=nextjs:nodejs /app/next.config.js ./next.config.js

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Prisma
COPY --from=builder --chown=nextjs:nodejs /app/prisma ./prisma
COPY --from=builder --chown=nextjs:nodejs /app/lib/generated ./lib/generated

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
COPY --from=builder --chown=nextjs:nodejs /app/ ./

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
RUN if [ -f "./start.sh" ]; then chmod +x ./start.sh; fi

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… nextjs
USER nextjs

# Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙˆØ±Øª
EXPOSE 3000

# Health check Ù„Ù„Ù€ Digital Ocean
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000/api/health || exit 1

# Ø£Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„
CMD if [ -f "./start.sh" ]; then sh ./start.sh; else npx next start -H 0.0.0.0 -p ${PORT}; fi
