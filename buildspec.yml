version: 0.2

env:
  variables:
    NODE_ENV: production
    NEXT_TELEMETRY_DISABLED: 1

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "ðŸ”„ Installing dependencies..."
      - npm ci --legacy-peer-deps
      - echo "ðŸ“¦ Dependencies installed successfully"

  pre_build:
    commands:
      - echo "ðŸ”„ Cleaning old Prisma..."
      - rm -rf node_modules/.prisma
      - rm -rf node_modules/@prisma/client
      - echo "ðŸ”„ Generating Prisma Client..."
      - npx prisma generate --force
      - echo "ðŸ” Checking Prisma Engine..."
      - ls -la node_modules/.prisma/client/ || true
      - echo "ðŸ” Environment check..."
      - 'echo "NODE_ENV: $NODE_ENV"'
      - 'if [ -z "$DATABASE_URL" ]; then echo "DATABASE_URL: NOT SET âŒ"; else echo "DATABASE_URL: SET âœ…"; fi'
      - echo "âœ… Pre-build completed"

  build:
    commands:
      - echo "ðŸ—ï¸ Building application..."
      - NODE_OPTIONS="--max-old-space-size=4096" npm run build
      - echo "ðŸ“Š Build size analysis..."
      - du -sh .next || true
      - echo "âœ… Build completed successfully"

  post_build:
    commands:
      - echo "ðŸ§¹ Post-build cleanup..."
      - echo "ðŸ“„ Generating build info..."
      - 'echo "Build completed at: $(date)" > .next/build-info.txt'
      - echo "âœ… Post-build completed"

artifacts:
  files:
    - '**/*'
  base-directory: .next

cache:
  paths:
    - node_modules/**/*
    - .next/cache/**/*
    - lib/generated/**/*
