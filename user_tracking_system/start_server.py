#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø³Ø¨Ù‚ Ø§Ù„Ø°ÙƒÙŠØ©
Ø³ÙƒØ±ÙŠØ¨Øª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
User Behavior Tracking System - Server Startup Script
"""

import asyncio
import sys
import os
import logging
from pathlib import Path

# Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Python path
current_dir = Path(__file__).parent
sys.path.insert(0, str(current_dir))

try:
    import uvicorn
    from api import app
    from config import settings
    from services.database import db_manager
    from services.redis_service import redis_manager
except ImportError as e:
    print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª: {e}")
    print("ÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª: pip install -r requirements.txt")
    sys.exit(1)

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger("sabq.tracking.startup")

async def check_dependencies():
    """ÙØ­Øµ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª"""
    logger.info("ğŸ” ÙØ­Øµ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª...")
    
    # ÙØ­Øµ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
    required_env_vars = [
        'DB_HOST', 'DB_PORT', 'DB_NAME', 'DB_USER', 'DB_PASSWORD',
        'REDIS_HOST', 'REDIS_PORT'
    ]
    
    missing_vars = []
    for var in required_env_vars:
        if not os.getenv(var):
            missing_vars.append(var)
    
    if missing_vars:
        logger.warning(f"âš ï¸  Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©: {', '.join(missing_vars)}")
        logger.info("Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©...")
    
    try:
        # ÙØ­Øµ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        logger.info("ğŸ”— ÙØ­Øµ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
        await db_manager.initialize()
        logger.info("âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØµÙ„Ø©")
        
        # ÙØ­Øµ Ø§ØªØµØ§Ù„ Redis
        logger.info("ğŸ”— ÙØ­Øµ Ø§ØªØµØ§Ù„ Redis...")
        await redis_manager.initialize()
        logger.info("âœ… Redis Ù…ØªØµÙ„")
        
        return True
        
    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª: {e}")
        return False

async def setup_database():
    """Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    try:
        logger.info("ğŸ—„ï¸  Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
        await db_manager.create_tables()
        logger.info("âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­")
        
        # ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
        logger.info("âš¡ ØªØ­Ø³ÙŠÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
        await db_manager.optimize_tables()
        logger.info("âœ… ØªÙ… ØªØ­Ø³ÙŠÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
        
    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
        raise

def print_startup_banner():
    """Ø·Ø¨Ø§Ø¹Ø© Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡"""
    banner = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…                     â•‘
â•‘                      Ø³Ø¨Ù‚ Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©                       â•‘
â•‘                                                              â•‘
â•‘    User Behavior Tracking System - Sabq AI Advanced         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """
    print(banner)

def print_server_info():
    """Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù…"""
    info = f"""
ğŸš€ ØªÙ… ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… ØªØªØ¨Ø¹ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!

ğŸ“¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù…:
   â€¢ Ø§Ù„Ù…Ø¶ÙŠÙ: 0.0.0.0:8000
   â€¢ Ø§Ù„Ø¨ÙŠØ¦Ø©: {settings.environment}
   â€¢ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: {settings.app_version}
   â€¢ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±: {settings.debug}

ğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ù‡Ù…Ø©:
   â€¢ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©: http://localhost:8000/docs
   â€¢ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ©: http://localhost:8000/health
   â€¢ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¨Ø¯ÙŠÙ„: http://localhost:8000/redoc

ğŸ—„ï¸  Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:
   â€¢ Ø§Ù„Ù†ÙˆØ¹: PostgreSQL
   â€¢ Ø§Ù„Ù…Ø¶ÙŠÙ: {settings.db_host}:{settings.db_port}
   â€¢ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {settings.db_name}

ğŸš€ Redis:
   â€¢ Ø§Ù„Ù…Ø¶ÙŠÙ: {settings.redis_host}:{settings.redis_port}
   â€¢ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {settings.redis_db}

ğŸ’¡ Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø§Ø¯Ù…: Ø§Ø¶ØºØ· Ctrl+C
    """
    print(info)

async def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    print_startup_banner()
    
    try:
        # ÙØ­Øµ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
        if not await check_dependencies():
            logger.error("âŒ ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª")
            return
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await setup_database()
        
        # Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù…
        print_server_info()
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
        config = uvicorn.Config(
            app,
            host="0.0.0.0",
            port=8000,
            reload=settings.debug,
            workers=1 if settings.debug else settings.worker_processes,
            log_level=settings.log_level.lower(),
            access_log=True,
            loop="asyncio"
        )
        
        server = uvicorn.Server(config)
        await server.serve()
        
    except KeyboardInterrupt:
        logger.info("â¹ï¸  ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…: {e}")
    finally:
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        logger.info("ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯...")
        try:
            await db_manager.close()
            await redis_manager.close()
        except:
            pass
        logger.info("âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯")

def run_server():
    """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… (Ù„Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† Ø®Ø§Ø±Ø¬ async)"""
    try:
        asyncio.run(main())
    except Exception as e:
        logger.error(f"âŒ ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…: {e}")
        sys.exit(1)

if __name__ == "__main__":
    run_server()
