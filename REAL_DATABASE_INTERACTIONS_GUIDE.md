# دليل حل مشكلة التفاعلات في قاعدة البيانات الحقيقية

## 🎯 المشكلة
التفاعلات (الإعجابات والحفظ) تختفي عند تحديث الصفحة لأنها كانت تُحفظ في localStorage فقط.

## ✅ الحل المطبق

### 1. **تحديث API لاستخدام قاعدة البيانات الحقيقية**
- تم تحديث `/api/interactions/track-activity/route.ts`
- استخدام Prisma بدلاً من ملفات JSON
- حفظ في جداول `interactions` و `loyalty_points` و `activity_logs`

### 2. **تحديث صفحة المقال**
- إرسال جميع التفاعلات إلى API (للمستخدمين والضيوف)
- معرف ثابت للضيوف: `guest-anonymous` أو معرف فريد
- نظام مزدوج: localStorage للسرعة + قاعدة البيانات للديمومة

### 3. **النظام الجديد يعمل كالتالي:**
```
المستخدم يضغط إعجاب
    ↓
تحديث واجهة المستخدم فوراً
    ↓
حفظ في localStorage (سريع)
    ↓
إرسال إلى قاعدة البيانات (دائم)
    ↓
عرض إشعار بالنقاط
```

## 🔧 للتحقق من عمل النظام

### 1. **تحقق من قاعدة البيانات محلياً:**
```bash
npx prisma studio
```
- افتح جدول `interactions`
- يجب أن ترى التفاعلات الجديدة

### 2. **تحقق من Logs:**
```javascript
// في المتصفح Console
localStorage.getItem('guestId')  // معرف الضيف
localStorage.getItem('sabq_interactions')  // التفاعلات المحلية
```

### 3. **اختبر التفاعلات:**
1. افتح مقال
2. اضغط إعجاب
3. حدث الصفحة (F5)
4. يجب أن يبقى الإعجاب محفوظاً

## 🚀 للنشر على الإنتاج

### 1. **تأكد من متغيرات البيئة:**
```env
DATABASE_URL="mysql://user:password@host:port/database"
```

### 2. **نفذ الأوامر:**
```bash
npm install
npx prisma generate
npx prisma db push
npm run build
npm start
```

### 3. **إذا كنت تستخدم Vercel:**
- أضف DATABASE_URL في إعدادات المشروع
- تأكد من أن قاعدة البيانات متاحة من Vercel

## ⚠️ ملاحظات مهمة

### للضيوف:
- معرف الضيف يُنشأ مرة واحدة ويُحفظ في localStorage
- التفاعلات تُحفظ بمعرف الضيف
- عند التسجيل، يمكن ترحيل التفاعلات

### للمستخدمين المسجلين:
- التفاعلات تُحفظ بمعرف المستخدم الحقيقي
- النقاط تُحسب وتُحفظ في جدول loyalty_points

### الأداء:
- localStorage يوفر استجابة فورية
- قاعدة البيانات تضمن الحفظ الدائم
- في حالة فشل الخادم، البيانات محفوظة محلياً

## 🐛 استكشاف الأخطاء

### إذا استمرت المشكلة:

1. **تحقق من Network Tab:**
   - هل طلب `/api/interactions/track-activity` يرجع 200؟
   - ما هي رسالة الخطأ إن وجدت؟

2. **تحقق من قاعدة البيانات:**
   ```sql
   SELECT * FROM interactions WHERE user_id LIKE 'guest%' ORDER BY created_at DESC;
   ```

3. **تحقق من الأذونات:**
   - هل المستخدم له صلاحية INSERT في الجداول؟

4. **مسح الذاكرة المؤقتة:**
   ```bash
   rm -rf .next
   npm run build
   ```

## 📞 الدعم
إذا احتجت مساعدة إضافية، تحقق من:
- سجلات الخادم
- Prisma logs
- Browser console 