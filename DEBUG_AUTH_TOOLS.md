# ุฃุฏูุงุช ุงูุชุดุฎูุต ุงููุชูุฏูุฉ ูููุตุงุฏูุฉ - DEBUG AUTH TOOLS

## ูุธุฑุฉ ุนุงูุฉ

ุชุญุชูู ูุฐู ุงูุฃุฏูุงุช ุนูู ูุฌููุนุฉ ุดุงููุฉ ูู ุฃุฏูุงุช ุงูุชุดุฎูุต ูุงููุญุต ูููุธุงู ุงููุตุงุฏูุฉ ุงูููุญุฏ ูู ุณุจู ุงูุฐููุฉ.

## ุงููููุงุช ูุงููุธุงุฆู

### 1. `lib/authClient.ts`
- **ุนููู ุงููุตุงุฏูุฉ ุงูุฃุณุงุณู** ูุน Single-flight refresh
- ููุน ุญููุงุช 401/refresh ุงููุงููุงุฆูุฉ
- ุฅุฏุงุฑุฉ ุงูุชููู ูู ุงูุฐุงูุฑุฉ ููุท
- Rate limiting ููู refresh attempts

**ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ:**
- `ensureAccessToken()` - ุถูุงู ูุฌูุฏ ุชููู ุตุงูุญ
- `performTokenRefresh()` - ุชุญุฏูุซ ุงูุชููู ูุน ููุน ุงูุณุจุงูุงุช  
- `clearSession()` - ุชูุธูู ุงูุฌูุณุฉ ุดุงููุงู
- `validateSession()` - ูุญุต ุตุญุฉ ุงูุฌูุณุฉ

### 2. `lib/debug-tools.ts`
- **ุฃุฏูุงุช ุงูุชุดุฎูุต ุงูุนุงูุฉ** ูููุตุงุฏูุฉ
- ูุญุต ุงูุชููู ูุญุงูุฉ ุงูููููุฒ
- ุงุฎุชุจุงุฑ endpoints ูุฎุชููุฉ
- ุฅุนุงุฏุฉ ุงูุชุนููู ุงูุดุงููุฉ

**ุงููุธุงุฆู ุงููุชุงุญุฉ:**
- `debugAuthState()` - ูุญุต ุดุงูู ูุญุงูุฉ ุงููุตุงุฏูุฉ
- `testTokenWithEndpoint(endpoint)` - ุงุฎุชุจุงุฑ ุงูุชููู ุนูู endpoint ูุญุฏุฏ
- `compareTokens()` - ููุงุฑูุฉ ุงูุชููู ูู ุงูุฐุงูุฑุฉ vs ุงูููููุฒ
- `resetEverything()` - ุฅุนุงุฏุฉ ุชุนููู ุดุงููุฉ

### 3. `lib/loyalty-debug.ts`
- **ุฃุฏูุงุช ูุชุฎุตุตุฉ** ูุชุดุฎูุต ูุดุงูู `/profile/me/loyalty`
- ูุญุต ูุชูุฏู ููู 401 ุงููุณุชูุฑ
- ุชุญููู ุงูููููุฒ ูุงูุชููู
- ุงุฎุชุจุงุฑุงุช ูุฎุตุตุฉ ููู loyalty endpoint

**ุงููุธุงุฆู ุงููุชุฎุตุตุฉ:**
- `diagnoseLoyaltyEndpoint()` - ุชุดุฎูุต ุดุงูู ูููุทุฉ loyalty
- `quickTokenTest()` - ุงุฎุชุจุงุฑ ุณุฑูุน ุนูู endpoints ูุชุนุฏุฏุฉ
- `analyzeCookies()` - ุชุญููู ุชูุตููู ููููููุฒ
- `resetAuthCompletely()` - ุฅุนุงุฏุฉ ุชุนููู ุทูุงุฑุฆ ุดุงููุฉ

## ููููุฉ ุงูุงุณุชุฎุฏุงู

### ูู ูุถุน ุงูุชุทููุฑ

ุงูุฃุฏูุงุช ูุชุงุญุฉ ุชููุงุฆูุงู ูู ูุญุฏุฉ ุงูุชุญูู:

```javascript
// ุงูุฃุฏูุงุช ุงูุนุงูุฉ
debugAuth.debugAuthState()                    // ูุญุต ุดุงูู ูููุตุงุฏูุฉ
debugAuth.testToken('/api/profile/me')        // ุงุฎุชุจุงุฑ endpoint ูุญุฏุฏ
debugAuth.compareTokens()                     // ููุงุฑูุฉ ุงูุชููู ูุงูููููุฒ
debugAuth.resetEverything()                   // ุฅุนุงุฏุฉ ุชุนููู ุดุงููุฉ

// ุฃุฏูุงุช Loyalty ุงููุชุฎุตุตุฉ
debugLoyalty.diagnoseLoyaltyEndpoint()        // ุชุดุฎูุต ูุดููุฉ 401 ูู loyalty
debugLoyalty.quickTokenTest()                 // ุงุฎุชุจุงุฑ ุณุฑูุน ูุชุนุฏุฏ
debugLoyalty.analyzeCookies()                 // ุชุญููู ุงูููููุฒ
debugLoyalty.resetAuthCompletely()            // ุฅุนุงุฏุฉ ุชุนููู ุทูุงุฑุฆ
```

### ุณููุงุฑูููุงุช ุงูุงุณุชุฎุฏุงู

#### 1. ุชุดุฎูุต 401 ูุณุชูุฑ ุนูู loyalty endpoint
```javascript
debugLoyalty.diagnoseLoyaltyEndpoint()
```
ูุฐุง ุณูููู ุจู:
- ูุญุต ุงูุชููู ุงูุญุงูู ูุตูุงุญูุชู
- ูุญุงููุฉ ุฃููู ุจุงูุชููู ุงูุญุงูู
- ุชุญุฏูุซ ุงูุชููู ุฅุฐุง ูุดูุช
- ูุญุงููุฉ ุซุงููุฉ ุจุงูุชููู ุงูุฌุฏูุฏ
- ุชุญููู ููุตู ูููุดููุฉ ุฅุฐุง ุงุณุชูุฑ 401

#### 2. ูุญุต ุนุงู ูุญุงูุฉ ุงููุตุงุฏูุฉ
```javascript
debugAuth.debugAuthState()
```

#### 3. ุงุฎุชุจุงุฑ endpoints ูุชุนุฏุฏุฉ
```javascript
debugLoyalty.quickTokenTest()
```

#### 4. ููุงุฑูุฉ ุงูุชููู ูู ุงูุฐุงูุฑุฉ ูุน ุงูููููุฒ
```javascript
debugAuth.compareTokens()
```

#### 5. ุฅุนุงุฏุฉ ุชุนููู ุดุงููุฉ ูููุตุงุฏูุฉ
```javascript
debugLoyalty.resetAuthCompletely()
// ุฃู ููุฃุฏูุงุช ุงูุนุงูุฉ
debugAuth.resetEverything()
```

## ุงููููุฒุงุช ุงููุชูุฏูุฉ

### Single-flight Refresh
- ููุน ุชุนุฏุฏ ุทูุจุงุช refresh ูู ููุณ ุงูููุช
- ุงุณุชุฎุฏุงู Promise ูุงุญุฏ ูุฌููุน ุงูุทูุจุงุช ุงููุชุฒุงููุฉ

### Rate Limiting
- ุญุฏ ุฃูุตู ูููุญุงููุงุช (1 ูุญุงููุฉ)
- ูุชุฑุฉ ุงูุชุธุงุฑ ุจูู ุงููุญุงููุงุช (30 ุซุงููุฉ)
- ููุน spam ุงูุฎุงุฏู

### Memory-only Token Storage
- ุนุฏู ุญูุธ ุงูุชููู ูู localStorage
- ููุน ุชุณุฑูุจ ุงูุชููู
- ุชูุธูู ุชููุงุฆู ุนูุฏ ุฅุบูุงู ุงูุฌูุณุฉ

### Cookie Priority System
- ูุธุงู ุฃููููุฉ ููููููุฒ ุงูููุญุฏุฉ vs ุงููุฏููุฉ
- ุฏุนู fallback ููููููุฒ ุงููุฏููุฉ
- ุชุดุฎูุต ุชุฏุงุฎู ุงูููููุฒ

## ุงูุชุญููู ุงูุชููุงุฆู

ุงูุฃุฏูุงุช ุชุชุญูู ุชููุงุฆูุงู ูู ูุถุน ุงูุชุทููุฑ ุนุจุฑ `components/DevToolsFix.tsx`:

```typescript
import('@/lib/debug-tools')     // ุงูุฃุฏูุงุช ุงูุนุงูุฉ
import('@/lib/loyalty-debug')   // ุฃุฏูุงุช loyalty
```

## ุฑุณุงุฆู ุงูู Console

ุงูุฃุฏูุงุช ุชุณุชุฎุฏู ุฑููุฒ ุชุนุจูุฑูุฉ ูุงุถุญุฉ:
- ๐ ูุญุต ูุชุดุฎูุต
- ๐งช ุงุฎุชุจุงุฑุงุช
- โ ูุฌุงุญ
- โ ูุดู
- ๐ ุชุญุฏูุซ ุงูุชููู
- ๐ช ุงูููููุฒ
- ๐ฏ loyalty ูุญุฏุฏ
- ๐ ุทูุงุฑุฆ

## ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฅุฐุง ูู ุชุธูุฑ ุงูุฃุฏูุงุช ูู Console:
1. ุชุฃูุฏ ูู ูุถุน development: `process.env.NODE_ENV === 'development'`
2. ุชุญูู ูู ุชุญููู `DevToolsFix` ูู ุงูููููุงุช
3. ุงูุชุญ Developer Tools ูุชุญุฏูุซ ุงูุตูุญุฉ

### ุฅุฐุง ุงุณุชูุฑ 401 ุจุนุฏ refresh:
1. ุงุณุชุฎุฏู `debugLoyalty.diagnoseLoyaltyEndpoint()`
2. ุชุญูู ูู ุงูููููุฒ ุจู `debugLoyalty.analyzeCookies()`
3. ุฌุฑุจ ุฅุนุงุฏุฉ ุชุนููู ุดุงููุฉ: `debugLoyalty.resetAuthCompletely()`

### ุฅุฐุง ูุงู ุงูุชููู ุบูุฑ ูุชุทุงุจู:
1. ุงุณุชุฎุฏู `debugAuth.compareTokens()`
2. ุชุญูู ูู ูุธุงู ุฃููููุฉ ุงูููููุฒ
3. ุงูุณุญ ุงูููููุฒ ุงููุฏููุฉ ูุฏููุงู

## ุงูุฃูุงู

- ุงูุฃุฏูุงุช ูุชุงุญุฉ **ููุท ูู ูุถุน ุงูุชุทููุฑ**
- ูุง ุชุญุชูุธ ุจุงูุชููู ูู localStorage
- ุชูุธูู ุชููุงุฆู ููุจูุงูุงุช ุงูุญุณุงุณุฉ
- ุญูุงูุฉ ูู Rate limiting attacks

---

**ููุงุญุธุฉ**: ูุฐู ุงูุฃุฏูุงุช ูุตููุฉ ูุญู ูุดููุฉ 401 ุงููุณุชูุฑ ุนูู `/profile/me/loyalty` ูุชุทููุฑ ูุธุงู ูุตุงุฏูุฉ ูุณุชูุฑ.
