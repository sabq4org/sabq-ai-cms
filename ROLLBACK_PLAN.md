# ุฎุทุฉ ุงูุชุฏููุฑ ูููุธุงู ุงูููุญุฏ ูููุตุงุฏูุฉ
# Rollback Plan for Unified Authentication System

## ๐ฏ **ููุฎุต ุงูุฅุตูุงุญุงุช ุงูููุทุจูุฉ**

### ุงููููุงุช ุงูููุญุฏูุซุฉ:

1. **lib/auth-cookies-unified.ts** โ
   - ูุธุงู ููููุฒ ููุญุฏ ูุน __Host- prefixes
   - ุฅุฏุงุฑุฉ CORS ูุญุณูุฉ
   - ุฏุนู ุนุฏุฉ ุฃููุงุน ูู ุงูููููุฒ

2. **app/api/auth/login/route.ts** โ
   - ุงุณุชุฎุฏุงู ุงููุธุงู ุงูููุญุฏ ููููููุฒ
   - ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณูุฉ
   - CORS headers ูููุญุฏุฉ

3. **app/api/auth/logout/route.ts** โ
   - ูุณุญ ุดุงูู ููููููุฒ
   - ุงุณุชุฌุงุจุฉ ููุญุฏุฉ

4. **app/api/auth/refresh/route.ts** โ
   - ุชุฌุฏูุฏ ุงูุชูููุฒ ุงููุญุณู
   - ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ

5. **app/api/auth/me/route.ts** โ
   - ุงุณุชุฎุฑุงุฌ ููุญุฏ ููุชูููุฒ
   - ุขููุงุช ุงุญุชูุงุทูุฉ ูุญุณูุฉ

6. **app/api/auth/refresh-token/route.ts** โ (ุฌุฏูุฏ)
   - ููุชูุงูู ูุน ุงููุธุงู ุงููุฏูู

7. **lib/auth/user-management.ts** โ
   - ุฅุตูุงุญ ูุงุฌูุฉ AuthResult
   - ุฏุนู JWT ูุญุณู

8. **lib/api-client.ts** โ (ุชู ุงูุงุณุชุจุฏุงู)
   - ูุธุงู refresh ูุญุณู
   - ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ
   - ุฏุนู ุงููุธุงู ุงูููุญุฏ

9. **contexts/AuthContext.tsx** โ
   - ุชูุงูู ูุน ุงููุธุงู ุงูููุญุฏ
   - ูุนุงูุฌุฉ race conditions
   - debouncing ูุญุณู

10. **middleware.ts** โ
    - ุญูุงูุฉ ุงููุณุงุฑุงุช ุงููุญููุฉ
    - ุฏุนู ุงููุธุงู ุงูููุญุฏ
    - rate limiting ูุญุณู

---

## ๐ **ุฎุทุฉ ุงูุชุฏููุฑ (Rollback Plan)**

### ุงููุฑุญูุฉ 1: ุงูุชุฏููุฑ ุงูุณุฑูุน (5 ุฏูุงุฆู)

```bash
# 1. ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุงููููุงุช ุงูุญุงููุฉ
mkdir -p backup/$(date +%Y%m%d_%H%M%S)
cp lib/auth-cookies-unified.ts backup/$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
cp app/api/auth/login/route.ts backup/$(date +%Y%m%d_%H%M%S)/
cp app/api/auth/logout/route.ts backup/$(date +%Y%m%d_%H%M%S)/
cp app/api/auth/refresh/route.ts backup/$(date +%Y%m%d_%H%M%S)/
cp app/api/auth/me/route.ts backup/$(date +%Y%m%d_%H%M%S)/
cp lib/auth/user-management.ts backup/$(date +%Y%m%d_%H%M%S)/
cp lib/api-client.ts backup/$(date +%Y%m%d_%H%M%S)/
cp contexts/AuthContext.tsx backup/$(date +%Y%m%d_%H%M%S)/
cp middleware.ts backup/$(date +%Y%m%d_%H%M%S)/

# 2. ุงุณุชุฑุฏุงุฏ ุงููุณุฎ ุงูุณุงุจูุฉ (ุฅุฐุง ุชููุฑุช)
git checkout HEAD~1 -- lib/api-client.ts
git checkout HEAD~1 -- contexts/AuthContext.tsx
git checkout HEAD~1 -- app/api/auth/login/route.ts
git checkout HEAD~1 -- app/api/auth/logout/route.ts
git checkout HEAD~1 -- app/api/auth/refresh/route.ts
git checkout HEAD~1 -- app/api/auth/me/route.ts
git checkout HEAD~1 -- lib/auth/user-management.ts
git checkout HEAD~1 -- middleware.ts

# 3. ุฅุฒุงูุฉ ุงููููุงุช ุงูุฌุฏูุฏุฉ
rm -f lib/auth-cookies-unified.ts
rm -f app/api/auth/refresh-token/route.ts

# 4. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู
npm run build
npm start
```

### ุงููุฑุญูุฉ 2: ุงูุชุฏููุฑ ุงููุชุฏุฑุฌ (15 ุฏูููุฉ)

ุฅุฐุง ูุดู ุงูุชุฏููุฑ ุงูุณุฑูุนุ ุงุชุจุน ูุฐู ุงูุฎุทูุงุช:

1. **ุฅููุงู ุงูุฎุฏูุฉ**
   ```bash
   pm2 stop all # ุฃู
   pkill -f "next"
   ```

2. **ุงุณุชุฑุฏุงุฏ ุชุฏุฑูุฌู**
   ```bash
   # ุงุณุชุฑุฏุงุฏ ููู ุชูู ุงูุขุฎุฑ
   git checkout HEAD~1 -- contexts/AuthContext.tsx
   git checkout HEAD~1 -- lib/api-client.ts
   git checkout HEAD~1 -- app/api/auth/
   git checkout HEAD~1 -- lib/auth/user-management.ts
   git checkout HEAD~1 -- middleware.ts
   ```

3. **ุชูุธูู ุงูููููุฒ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุฅู ููุฌุฏุช)**
   ```sql
   -- ุฅุฐุง ูุงูุช ุงูููููุฒ ูุฎุฒูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   DELETE FROM user_sessions WHERE created_at > '2024-12-26';
   ```

4. **ุฅุนุงุฏุฉ ุงูุจูุงุก ูุงูุชุดุบูู**
   ```bash
   npm run build
   npm start
   ```

---

## ๐ **ูุงุฆูุฉ ุงูุชุญูู ูุจู ุงููุดุฑ**

### โ **ุงุฎุชุจุงุฑุงุช ุงููุธุงุฆู ุงูุฃุณุงุณูุฉ**

- [ ] ุชุณุฌูู ุงูุฏุฎูู ูุนูู ุจูุฌุงุญ
- [ ] ุชุณุฌูู ุงูุฎุฑูุฌ ููุธู ุงูููููุฒ
- [ ] ุชุฌุฏูุฏ ุงูุชููู ูุญุฏุซ ุชููุงุฆูุงู
- [ ] ุจูุงูุงุช ุงููุณุชุฎุฏู ุชูุณุชุฑุฏ ุจูุฌุงุญ
- [ ] ุงูููููุฒ ุชูุถุจุท ุจุดูู ุตุญูุญ
- [ ] CORS ูุนูู ูููุชุตูุญุงุช ุงููุฎุชููุฉ

### โ **ุงุฎุชุจุงุฑุงุช ุงูุงุณุชูุฑุงุฑ**

- [ ] 100 ุนูููุฉ refresh ูุชุชุงููุฉ ุจุฏูู ูุดู
- [ ] 50 ุนูููุฉ "ุฅุนุฌุงุจ" ุจุฏูู ุงููุทุงุน ุงูุฌูุณุฉ
- [ ] ุงูุฌูุณุฉ ุชุณุชูุฑ ูู 24 ุณุงุนุฉ (ุฃู ุญุณุจ ุงูุฅุนุฏุงุฏ)
- [ ] ูุง ุชูุฌุฏ race conditions ูู AuthContext
- [ ] ูุง ุชูุฌุฏ ุชุณุฑุจุงุช ูู ุงูุฐุงูุฑุฉ

### โ **ุงุฎุชุจุงุฑุงุช ุงูุฃูุงู**

- [ ] ุงูููููุฒ ุชุณุชุฎุฏู Secure ู HttpOnly
- [ ] __Host- prefixes ุชุนูู ูู HTTPS
- [ ] ุงูููููุฒ ุชููุณุญ ุนูุฏ ุชุณุฌูู ุงูุฎุฑูุฌ
- [ ] JWT tokens ููุง expiry ุตุญูุญ
- [ ] Rate limiting ูุนูู ููู API endpoints

### โ **ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู**

- [ ] ูุนูู ูู Chrome
- [ ] ูุนูู ูู Firefox
- [ ] ูุนูู ูู Safari
- [ ] ูุนูู ูู Edge
- [ ] ูุนูู ุนูู ุงูููุจุงูู

---

## ๐จ **ูุคุดุฑุงุช ุงูุชุญุฐูุฑ ููุชุฏููุฑ**

### ูุคุดุฑุงุช ุญูุฑุงุก (ุชุฏููุฑ ููุฑู):

1. **ูุนุฏู ูุดู ุชุณุฌูู ุงูุฏุฎูู > 10%**
2. **ุงููุทุงุน ุงูุฌูุณุงุช ุจุดูู ูุชูุฑุฑ**
3. **ุฃุฎุทุงุก CORS ูู ุงููุชุตูุญ**
4. **ุนุฏู ุญูุธ ุงูููููุฒ**
5. **ุฃุฎุทุงุก 500 ูู API endpoints**

### ูุคุดุฑุงุช ุตูุฑุงุก (ูุฑุงูุจุฉ ููุซูุฉ):

1. **ูุนุฏู ูุดู ุชุณุฌูู ุงูุฏุฎูู 5-10%**
2. **ุจุทุก ูู ุงุณุชุฌุงุจุฉ API**
3. **ุชุญุฐูุฑุงุช ูู console ุงููุชุตูุญ**
4. **ูุนุฏู ูุดู refresh token > 5%**

---

## ๐ **ุฎุทุฉ ุงูุชูุงุตู ูู ุญุงูุฉ ุงูุทูุงุฑุฆ**

### ูู ุญุงูุฉ ุงูุญุงุฌุฉ ููุชุฏููุฑ:

1. **ุฅุดุนุงุฑ ููุฑู ูููุณุชุฎุฏููู**
   ```javascript
   // ุนุฑุถ ุฑุณุงูุฉ ูู ุงูุชุทุจูู
   "ูุญู ูุนูู ุนูู ุตูุงูุฉ ุณุฑูุนุฉ ูููุธุงู. ุณูุชู ุญู ุงููุดููุฉ ุฎูุงู ุฏูุงุฆู."
   ```

2. **ุชุณุฌูู ููุตู**
   ```bash
   # ุชูุนูู ุชุณุฌูู ููุตู
   export DEBUG=*
   export NODE_ENV=development
   npm start
   ```

3. **ูุฑุงูุจุฉ ูุณุชูุฑุฉ**
   ```bash
   # ูุฑุงูุจุฉ ูููุงุช ุงูู logs
   tail -f logs/error.log
   tail -f logs/access.log
   ```

---

## ๐ง **ุฅุนุฏุงุฏุงุช ุงูุทูุงุฑุฆ**

### ูู ุญุงูุฉ ุนุฏู ูุฌุงุญ ุงูุชุฏููุฑุ ุงุณุชุฎุฏู ูุฐู ุงูุฅุนุฏุงุฏุงุช:

```env
# ุฅุนุฏุงุฏุงุช ุขููุฉ ููุทูุงุฑุฆ
JWT_SECRET=fallback_secret_key_here
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d
COOKIE_SECURE=false
COOKIE_SAME_SITE=lax
CORS_ORIGIN=*
```

---

## ๐ **ูุฑุงูุจุฉ ูุง ุจุนุฏ ุงููุดุฑ**

### ุงูููุงููุณ ุงููุทููุจ ูุฑุงูุจุชูุง:

1. **ูุนุฏู ูุฌุงุญ ุชุณุฌูู ุงูุฏุฎูู**
2. **ูุนุฏู ูุฌุงุญ ุชุฌุฏูุฏ ุงูุชููู**
3. **ููุช ุงุณุชุฌุงุจุฉ API**
4. **ุนุฏุฏ ุงูุฌูุณุงุช ุงููุดุทุฉ**
5. **ุฃุฎุทุงุก JavaScript ูู ุงููุชุตูุญ**

### ุฃุฏูุงุช ุงููุฑุงูุจุฉ:

```bash
# ูุฑุงูุจุฉ ุงูู performance
npm install --save-dev clinic
clinic doctor -- node server.js

# ูุฑุงูุจุฉ ุงูุฐุงูุฑุฉ
node --inspect server.js
```

---

## โ **ุชุฃููุฏ ุงูุฌุงูุฒูุฉ**

**ุชุญูู ูู ุฃู ุฌููุน ุงูููุงุท ุงูุชุงููุฉ ููุชููุฉ ูุจู ุงููุดุฑ:**

- [ ] ุฌููุน ุงููููุงุช ูุญุฏุซุฉ ูุชุนูู ุจูุฌุงุญ
- [ ] ุงุฎุชุจุงุฑ ุดุงูู ุชู ุจุงุณุชุฎุฏุงู `test-unified-auth.js`
- [ ] ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุชููุฑุฉ
- [ ] ุฎุทุฉ ุงูุชุฏููุฑ ุฌุงูุฒุฉ
- [ ] ูุฑูู ุงูุฏุนู ููุทูุน ุนูู ุงูุชุบููุฑุงุช

---

**๐ ููุงุญุธุฉ:** ูุฐู ุงูุฎุทุฉ ุชุถูู ุงูุนูุฏุฉ ุงูุณุฑูุนุฉ ููุญุงูุฉ ุงููุณุชูุฑุฉ ุงูุณุงุจูุฉ ูู ุญุงูุฉ ุธููุฑ ูุดุงูู ูุน ุงููุธุงู ุงูุฌุฏูุฏ.
