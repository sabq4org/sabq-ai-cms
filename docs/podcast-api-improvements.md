# تحسينات API توليد البودكاست

## التحديثات الرئيسية

### 1. الأمان - إضافة CRON_SECRET
- يتم التحقق من `x-cron-secret` في header الطلبات
- يمنع الوصول غير المصرح به لـ API
- مطلوب في البيئة الإنتاجية

### 2. تقصير النص
- تم تحديد النص المُولد بـ 1000 حرف كحد أقصى
- تقليل max_tokens في GPT إلى 500
- نص افتراضي مختصر في حالة فشل GPT

### 3. معالجة محسنة لأخطاء ElevenLabs
معالجة تفصيلية لأنواع الأخطاء:
- **401**: مفتاح API غير صحيح
- **402**: رصيد غير كافٍ
- **400**: نص طويل جداً أو غير صالح
- استخراج رسائل الخطأ من الاستجابة

### 4. دعم رفع الملفات للخادم
- إمكانية رفع الملف الصوتي لخادم خارجي
- استخدام `SITE_UPLOAD_ENDPOINT` إن وُجد
- fallback لـ Base64 في حالة الفشل

## متغيرات البيئة المطلوبة

```env
# مفاتيح API الأساسية
OPENAI_API_KEY=sk-...
ELEVENLABS_API_KEY=...

# الأمان
CRON_SECRET=secret-key-here

# اختياري - لرفع الملفات
SITE_UPLOAD_ENDPOINT=https://your-server.com/upload
```

## مثال استخدام API

### طلب يدوي
```bash
curl -X POST https://your-site.com/api/generate-podcast \
  -H "Content-Type: application/json" \
  -H "x-cron-secret: your-secret-key" \
  -d '{
    "count": 5,
    "voice": "EXAVITQu4vr4xnSDxMaL",
    "language": "arabic"
  }'
```

### الاستجابة الناجحة
```json
{
  "success": true,
  "link": "https://...",
  "text": "نص النشرة...",
  "duration": 2,
  "timestamp": "2024-01-20T10:30:00Z",
  "uploaded": true
}
```

### استجابة الخطأ
```json
{
  "success": false,
  "error": "رصيد ElevenLabs غير كافٍ. يرجى شحن الرصيد.",
  "text": "النص المُولد (إن وُجد)"
}
```

## معالجة الأخطاء

### سلسلة الأخطاء والحلول البديلة:
1. **فشل جلب الأخبار** → استخدام mock data
2. **فشل GPT** → نص افتراضي مختصر
3. **فشل ElevenLabs** → إرجاع النص فقط
4. **فشل الرفع** → استخدام Base64

## نصائح للاستخدام

1. **تقليل التكلفة**:
   - استخدم نصوص قصيرة (أقل من 1000 حرف)
   - قلل عدد الأخبار في النشرة
   - استخدم أصوات ElevenLabs الأقل تكلفة

2. **تحسين الأداء**:
   - فعّل `SITE_UPLOAD_ENDPOINT` لتخزين دائم
   - استخدم caching للنشرات المتكررة
   - راقب استهلاك الرصيد

3. **الأمان**:
   - استخدم `CRON_SECRET` قوي
   - قيّد الوصول لـ API بـ IP whitelist
   - راقب السجلات للكشف عن محاولات غير مصرح بها 