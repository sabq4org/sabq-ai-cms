# دليل تكامل أخبار واس (وكالة الأنباء السعودية)

## 📊 نظرة عامة

تم إنشاء قسم متكامل لجلب وعرض الأخبار من وكالة الأنباء السعودية (واس) عبر API الرسمي.

## ⚠️ حالة الخدمة الحالية

**تحديث مهم (ديسمبر 2024):** خدمة واس API تواجه مشاكل تقنية من جهة السيرفر (خطأ 400/500).

### المشكلة:
- جميع endpoints ما عدا `Get_Status` تُرجع خطأ 400 أو 500
- تم التحقق من صحة المفاتيح والبيانات (Client Status: Active)
- المشكلة من جهة سيرفر واس وليست من الكود

### ما تم التحقق منه:
- ✅ API Key صحيح ونشط
- ✅ Client credentials صحيحة (SABQ)
- ✅ Endpoints صحيحة
- ✅ طريقة الاستدعاء صحيحة (GET مع body)
- ✅ تم استخدام البيانات من البرومبت الرسمي
- ❌ السيرفر يُرجع أخطاء للطلبات

### التوصيات:
1. انتظار حل المشكلة من جهة واس
2. التواصل مع الدعم الفني لواس
3. الكود جاهز 100% وسيعمل فور حل المشكلة

## 🔵 البرومبت الرسمي للربط

تم استلام برومبت متكامل من الفريق يحتوي على:

### متغيرات البيئة المطلوبة:
```env
SPA_API_URL=https://nwdistapi.spa.gov.sa/
SPA_API_KEY=owuDXImzoEIyRUJ4564z75O9WKGn44456353459bOOdfgdfxfV7qsvkEn5drAssdgfsgrdfgfdE3Q8drNupAHpHMTlljEkfjfjkfjkfjkfi84jksjds456d568y27893289kj89389d889jkjkjkdk490k3656d5asklskGGP
SPA_CLIENT_KEY=olU7cUWPqYGizEUMkau0iUw2xgMkLiJMrUcP6pweIWMp04mlNcW7pF/J12loX6YWHfw/kdQP4E7SPysGCzgK027taWDp11dvC2BYtE+W1nOSzqhHC2wPXz/LBqfSdbqSMxx0ur8Py4NVsPeq2PgQL4UqeXNak1qBknm45pbAW+4=
SPA_CLIENT_NAME=SABQ
```

### متطلبات الربط البرمجي:
- ✅ تمرير المتغيرات في كل طلب
- ✅ جميع الطلبات عبر HTTPS فقط
- ✅ التعامل مع كل الأخطاء البرمجية
- ✅ الاستجابة للمعايير غير الوظيفية

## 🏗️ المكونات

### 1. API Endpoint
**المسار:** `/app/api/was-news/route.ts`

**المميزات:**
- جلب الأخبار من API واس الرسمي
- معالجة أخطاء شاملة
- دعم GET و POST
- تحويل البيانات لصيغة موحدة
- فحص حالة الاتصال

**استخدام API:**
```bash
# جلب الأخبار
GET /api/was-news

# جلب الأخبار مع فلاتر
POST /api/was-news
{
  "last_news_CD": 0,
  "basket_CD": 1,
  "IS_load_media": true
}
```

### 2. صفحة لوحة التحكم
**المسار:** `/app/dashboard/was-news/page.tsx`

**المميزات:**
- واجهة متجاوبة وجميلة
- عرض البيانات الإحصائية
- بحث وفلترة متقدمة
- تحديث تلقائي كل 10 دقائق
- عرض تفاصيل الأخبار مع الصور
- دعم الوضع الليلي
- معالجة ذكية للأخطاء

### 3. قائمة التنقل
تم إضافة رابط "أخبار واس" في قسم "المحتوى والتحرير" في قائمة لوحة التحكم.

## ⚙️ التكوين

### مفاتيح API واس
```javascript
const SPA_API_KEY = "owuDXImzoEIyRUJ4564z75O9WKGn44456353459bOOdfgdfxfV7qsvkEn5drAssdgfsgrdfgfdE3Q8drNupAHpHMTlljEkfjfjkfjkfjkfi84jksjds456d568y27893289kj89389d889jkjkjkdk490k3656d5asklskGGP";
const SPA_CLIENT_NAME = "SABQ";
const SPA_CLIENT_KEY = "olU7cUWPqYGizEUMkau0iUw2xgMkLiJMrUcP6pweIWMp04mlNcW7pF/J12loX6YWHfw/kdQP4E7SPysGCzgK027taWDp11dvC2BYtE+W1nOSzqhHC2wPXz/LBqfSdbqSMxx0ur8Py4NVsPeq2PgQL4UqeXNak1qBknm45pbAW+4=";
```

### Endpoints المتاحة
```javascript
const ENDPOINTS = {
  GET_STATUS: "https://nwDistAPI.spa.gov.sa/api/ClientAppSDAIA/Get_Status",
  GET_NEXT_NEWS: "https://nwDistAPI.spa.gov.sa/api/ClientAppSDAIA/Get_Next_News",
  GET_BASKETS: "https://nwDistAPI.spa.gov.sa/api/ClientAppSDAIA/Get_Baskets"
};
```

### هيكل البيانات
```typescript
interface WasNewsItem {
  id: string;
  title: string;
  summary?: string;
  content?: string;
  publishDate: string;
  category?: string;
  imageUrl?: string;
  priority?: string;
  language?: string;
}
```

### معاملات الطلب
```javascript
{
  "Client": {
    "client_name_TXT": "SABQ",
    "client_key_TXT": "olU7cUWPqYGizEUMkau0iUw2xgMkLiJM..."
  },
  "last_news_CD": 0,      // آخر رقم خبر تم جلبه
  "basket_CD": 1,         // رقم السلة
  "IS_recived": true,     // تأكيد الاستلام
  "IS_load_media": true   // تحميل الوسائط
}
```

## 🔧 الاستخدام

### 1. الوصول للصفحة
زر لوحة التحكم → المحتوى والتحرير → أخبار واس

أو مباشرة: `http://localhost:3000/dashboard/was-news`

### 2. المميزات المتوفرة
- **عرض إحصائي:** إجمالي الأخبار، التصنيفات، آخر تحديث، حالة الاتصال
- **بحث متقدم:** البحث في العناوين والملخصات
- **فلترة:** حسب التصنيف
- **ترتيب:** حسب التاريخ، العنوان، أو التصنيف
- **تحديث تلقائي:** كل 10 دقائق
- **تحديث يدوي:** زر التحديث

### 3. عرض الأخبار
- عرض شبكي متجاوب (3 أعمدة على الشاشات الكبيرة)
- صور الأخبار (إن وجدت)
- مؤشر الأولوية (أحمر، أصفر، أخضر)
- التصنيف واللغة
- وقت النشر (نسبي ومطلق)

## 🛠️ معالجة الأخطاء

### أخطاء API شائعة:
- **400:** Bad Request - مشكلة في صيغة البيانات
- **404:** endpoint غير صحيح
- **405:** method غير مسموح
- **500:** خطأ في سيرفر واس
- **401/403:** مشكلة في المفاتيح
- **Network:** مشكلة في الاتصال

### الاستجابة للأخطاء:
- عرض رسائل خطأ واضحة
- إعادة المحاولة التلقائية
- عرض حالة الاتصال في الواجهة
- إرشادات خاصة لكل نوع خطأ

## 📱 التجاوب

الواجهة محسّنة للأجهزة المختلفة:
- **موبايل:** عمود واحد
- **تابلت:** عمودان
- **سطح المكتب:** ثلاثة أعمدة

## 🔄 التحديث التلقائي

- تحديث تلقائي كل 10 دقائق
- عدم إظهار مؤشر التحميل أثناء التحديث التلقائي
- حفظ آخر وقت تحديث

## 🎨 التصميم

- دعم الوضع الليلي/النهاري
- تصميم متدرج وأنيق
- أيقونات واضحة
- انتقالات سلسة
- ألوان تمييزية للحالات

## 🚀 التطوير المستقبلي

### مميزات مقترحة:
1. **حفظ الأخبار:** إمكانية حفظ أخبار مهمة في قاعدة البيانات
2. **إشعارات:** تنبيهات للأخبار العاجلة
3. **تصدير:** تصدير الأخبار بصيغ مختلفة
4. **تحليلات:** إحصائيات عن استهلاك الأخبار
5. **مشاركة:** مشاركة الأخبار على المنصات الاجتماعية

### تحسينات تقنية:
1. **Cache:** تخزين مؤقت للأخبار
2. **Pagination:** تقسيم النتائج لصفحات
3. **Real-time:** تحديث فوري عبر WebSocket
4. **Integration:** ربط مع نظام إدارة المحتوى

## 🔍 استكشاف الأخطاء

### مشكلة عدم ظهور الأخبار:
1. تحقق من اتصال الإنترنت
2. تأكد من صحة مفاتيح API
3. تحقق من سجلات المتصفح
4. اختبر API مباشرة: `/api/was-news`

### مشكلة البطء:
1. زد قيمة timeout في API
2. تحقق من سرعة الإنترنت
3. راجع سجلات الخادم

### خطأ 400/500 من واس:
1. المشكلة من جهة سيرفر واس
2. انتظر حتى يتم حل المشكلة
3. تواصل مع الدعم الفني لواس

## 🔍 مراقبة حالة الخدمة

تم إنشاء سكريبت لمراقبة حالة واس API بشكل دوري:

```bash
# تشغيل السكريبت
./scripts/check-was-api-status.sh

# السكريبت يقوم بـ:
# - فحص حالة الخدمة كل 5 دقائق
# - إظهار حالة كل endpoint
# - تنبيه صوتي عند عودة الخدمة
# - إيقاف تلقائي عند نجاح الاتصال
```

## 💡 تنبيهات هامة

بناءً على البرومبت الرسمي:
- ✅ تأكد من صحة اسم العميل ومفتاح العميل حسب بيانات العقد
- ✅ جميع البيانات المستلمة يتم التعامل معها وفق بنية NewsData
- ✅ استخدم خاصية IS_load_media: true لتحميل الوسائط تلقائياً
- ✅ يفضل الاحتفاظ برقم آخر خبر تم جلبه last_news_CD في قاعدة البيانات
- ✅ عالج الأكواد التي تتعلق بالمصادقة وواجهات REST بدقة شديدة

## 📞 الدعم

للدعم التقني أو الاستفسارات، راجع:
- سجلات المتصفح (F12 → Console)
- سجلات الخادم
- ملف التوثيق الرئيسي
- البرومبت الرسمي المرفق 